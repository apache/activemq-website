<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="/js/fontawesome-v5.0.8-all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ"></script>
    <script src="/js/jquery-3.6.1.slim.min.js" integrity="sha384-MYL22lstpGhSa4+udJSGro5I+VfM13fdJfCbAzP9krCEoK5r2EDFdgTg2+DGXdj+"></script>
    <script src="/js/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"></script>
    <script src="/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/news">News</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Get Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://whimsy.apache.org/board/minutes/ActiveMQ.html">Board Reports</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-nms">
    <div class="container">
      <h1>NMS.ActiveMQ Virtual Destinations</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 nms">
        <p><em>Virtual Destinations</em> allow us to create logical destinations that clients can use to produce and consume from but which map onto one or more <em>physical destinations</em>. It allows us to provide more flexible loosely coupled messaging configurations.</p>

<h2 id="virtual-topics">Virtual Topics</h2>

<p>The idea behind <em>publish subscribe</em> is a great one. Allow producers to be decoupled from consumers so that they do not even know how many consumers are interested in the messages they publish. The JMS specification defines support for durable topics however they have limitations as we will describe…</p>

<h3 id="the-limitations-of-jms-durable-topics">The limitations of JMS durable topics</h3>

<p>A JMS durable subscriber MessageConsumer is created with a unique JMS clientID and durable subscriber name. To be JMS compliant only one JMS connection can be active at any point in time for one JMS clientID, and only one consumer can be active for a clientID and subscriber name. i.e., only <strong>one</strong> thread can be actively consuming from a given logical topic subscriber. This means we cannot implement</p>

<ul>
  <li>load balancing of messages.</li>
  <li>fast failover of the subscriber if that one process running that one consumer thread dies.</li>
</ul>

<p>Now <em>queue</em> semantics in JMS offer the ability to load balance work across a number of consumers in a reliable way - allowing many threads, processes and machines to be used to process messages. Then we have sophisticated sticky load balancing techniques like <a href="..Features/Consumer FeaturesFeatures/Consumer Features/Features/Consumer Features/message-groups.md">Message Groups</a> to load balance and parallelise work while maintaining ordering.</p>

<p>Another added benefit of having physical queues for each logical topic subscriber is we can them monitor the queue depths via <a href="..Features/jmx.md">JMX</a> to monitor system performance together with being able to browse these physical queues.</p>

<h3 id="virtual-topics-to-the-rescue">Virtual Topics to the rescue</h3>

<p>The idea behind virtual topics is that producers send to a topic in the usual JMS way. Consumers can continue to use the Topic semantics in the JMS specification. However if the topic is virtual, consumer can consume from a physical queue for a logical topic subscription, allowing many consumers to be running on many machines &amp; threads to load balance the load.</p>

<p>E.g., let’s say we have a topic called <code class="language-plaintext highlighter-rouge">VirtualTopic.Orders</code>. (Where the prefix VirtualTopic. indicates its a virtual topic). And we logically want to send orders to systems A and B. Now with regular durable topics we’d create a JMS consumer for clientID_A and “A” along with clientID_B and “B”.</p>

<p>With virtual topics we can just go right ahead and consume to queue <code class="language-plaintext highlighter-rouge">Consumer.A.VirtualTopic.Orders</code> to be a consumer for system A or consume to <code class="language-plaintext highlighter-rouge">Consumer.B.VirtualTopic.Orders</code> to be a consumer for system B.</p>

<p>We can now have a pool of consumers for each system which then compete for messages for systems A or B such that all the messages for system A are processed exactly once and similarly for system B.</p>

<h3 id="customizing-the-out-of-the-box-defaults">Customizing the out-of-the-box defaults</h3>

<p>The out-of-the-box defaults are described above. Namely that the only virtual topics available must be within the <code class="language-plaintext highlighter-rouge">VirtualTopic.&gt;</code> namespace and that the consumer queues are named <code class="language-plaintext highlighter-rouge">Consumer.*.VirtualTopic.&gt;</code>.</p>

<p>You can configure this to use whatever naming convention you wish. The following <a href="https://svn.apache.org/repos/asf/incubator/activemq/trunk/activemq-unit-tests/src/test/resources/org/apache/activemq/broker/virtual/global-virtual-topics.xml">example</a> shows how to make all topics virtual topics. The example below is using the name <code class="language-plaintext highlighter-rouge">&gt;</code> to indicate ‘match all topics’. You could use this wildcard to apply different virtual topic policies in different hierarchies.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;destinationInterceptors&gt;
  &lt;virtualDestinationInterceptor&gt;
    &lt;virtualDestinations&gt;
      &lt;virtualTopic name="&gt;" prefix="VirtualTopicConsumers.*." selectorAware="false"/&gt;
    &lt;/virtualDestinations&gt;
  &lt;/virtualDestinationInterceptor&gt;
&lt;/destinationInterceptors&gt;
</code></pre></div></div>

<p>Note that making a topic virtual does add a small CPU overhead when sending messages to the topic but it is fairly small.</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>selectorAware</td>
      <td>false</td>
      <td>only messages that match one of the existing subscribers are actually dispatched. Using this option prevents the build up of unmatched messages when selectors are used by exclusive consumers</td>
    </tr>
    <tr>
      <td>local</td>
      <td>false</td>
      <td>when true, don’t fan out messages that were received over a network</td>
    </tr>
    <tr>
      <td>concurrentSend</td>
      <td>false</td>
      <td>when true, use an executor to fanout such that sends occur in parallel. This allows the journal to batch writes which will reduce disk io (5.12)</td>
    </tr>
    <tr>
      <td>transactedSend</td>
      <td>false</td>
      <td>when true, use a transaction for fanout sends such that there is a single disk sync. A local broker transaction will be created if there is no client transaction (5.13)</td>
    </tr>
  </tbody>
</table>

<h2 id="composite-destinations">Composite Destinations</h2>

<p>Composite Destinations allow for one-to-many relationships on individual destinations; the main use case is for <em>composite queues</em>. For example when a message is sent to queue A you may want to forward it also to queues B and C and topic D. Composite destinations are then a mapping from a virtual destination to a collection of other physical destinations. In this case the mapping is broker side and the client is unaware of the mapping between the destinations. This is different from client side <a href="..Features/Destination Features/Features/Destination Features/composite-destinations.md">Composite Destinations</a> where the client uses a URL notation to specify the actual physical destinations that a message must be sent to.</p>

<p>The following <a href="http://svn.apache.org/repos/asf/incubator/activemq/trunk/activemq-unit-tests/src/test/resources/org/apache/activemq/broker/virtual/composite-queue.xml">example</a> shows how to set up a <code class="language-plaintext highlighter-rouge">&lt;compositeQueue/&gt;</code> element in the XML configuration so that when a message is sent to <code class="language-plaintext highlighter-rouge">MY.QUEUE</code> then it is really forwarded to the physical queue <code class="language-plaintext highlighter-rouge">FOO</code> and the topic <code class="language-plaintext highlighter-rouge">BAR</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;destinationInterceptors&gt;
  &lt;virtualDestinationInterceptor&gt;
    &lt;virtualDestinations&gt;
      &lt;compositeQueue name="MY.QUEUE"&gt;
        &lt;forwardTo&gt;
          &lt;queue physicalName="FOO" /&gt;
          &lt;topic physicalName="BAR" /&gt;
        &lt;/forwardTo&gt;
      &lt;/compositeQueue&gt;
    &lt;/virtualDestinations&gt;
  &lt;/virtualDestinationInterceptor&gt;
&lt;/destinationInterceptors&gt;
</code></pre></div></div>

<p>By default, subscribers cannot consume messages directly from a composite queue or topic - it is a logical construct only. Given the configuration above, subscribers can only consume messages from <code class="language-plaintext highlighter-rouge">FOO</code> and <code class="language-plaintext highlighter-rouge">BAR</code>; but not <code class="language-plaintext highlighter-rouge">MY.QUEUE</code>.</p>

<p>This behaviour can be altered to implement use cases such as watching a queue by sending the same messages to a notification topic (wire tapping), by setting the optionally set <code class="language-plaintext highlighter-rouge">forwardOnly</code> attribute to false.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;compositeQueue name="IncomingOrders" forwardOnly="false"&gt;
  &lt;forwardTo&gt;
    &lt;topic physicalName="Notifications" /&gt;
  &lt;/forwardTo&gt;
&lt;/compositeQueue&gt;
</code></pre></div></div>

<p>Messages sent to <code class="language-plaintext highlighter-rouge">IncomingOrders</code> will all be copied and forwarded to <code class="language-plaintext highlighter-rouge">Notifications</code>, before being placed on the physical <code class="language-plaintext highlighter-rouge">IncomingOrders</code> queue for consumption by subscribers.</p>

<p>Where the <code class="language-plaintext highlighter-rouge">forwardOnly</code> attribute is not defined or is set to <code class="language-plaintext highlighter-rouge">true</code>, there is no logical difference between a <code class="language-plaintext highlighter-rouge">compositeQueue</code> and a <code class="language-plaintext highlighter-rouge">compositeTopic</code> - they can be used interchangeably. It is only when a composite destination is made physical through the use of <code class="language-plaintext highlighter-rouge">forwardOnly</code> that the choice of <code class="language-plaintext highlighter-rouge">compositeTopic</code>/<code class="language-plaintext highlighter-rouge">compositeQueue</code> has an impact on behavior.</p>

<h3 id="using-filtered-destinations">Using filtered destinations</h3>

<p>From Apache ActiveMQ <strong>4.2</strong> onwards you can now use selectors to define virtual destinations.</p>

<p>You may wish to create a virtual destination which forwards messages to multiple destinations but applying a selector first to decide if the message really does have to go to a particular destination.</p>

<p>The following example shows how a message sent to the virtual destination <code class="language-plaintext highlighter-rouge">MY.QUEUE</code> will be forwarded to <code class="language-plaintext highlighter-rouge">FOO</code> and <code class="language-plaintext highlighter-rouge">BAR</code> if the selectors match</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;destinationInterceptors&gt;
  &lt;virtualDestinationInterceptor&gt;
    &lt;virtualDestinations&gt;
      &lt;compositeQueue name="MY.QUEUE"&gt;
        &lt;forwardTo&gt;
          &lt;filteredDestination selector="odd = 'yes'" queue="FOO"/&gt;
          &lt;filteredDestination selector="i = 5" topic="BAR"/&gt;
        &lt;/forwardTo&gt;
      &lt;/compositeQueue&gt;
    &lt;/virtualDestinations&gt;
  &lt;/virtualDestinationInterceptor&gt;
&lt;/destinationInterceptors&gt;
</code></pre></div></div>

<h2 id="avoiding-duplicate-message-in-a-network-of-brokers">Avoiding Duplicate Message in a Network of Brokers</h2>

<p>You have to make sure that the messages sent to the <code class="language-plaintext highlighter-rouge">Consumer.*.VirtualTopic.&gt;</code> destination are not forwarded when you’re using both queue-based and non-queue based subscribers to the virtual topic (that is, if you have normal topic subscribers to the virtual topic). If you use Virtual Topics in a network of brokers, it is likely you will get duplicate messages if you use the default network configuration. This is because a network node will not only forward message sent to the virtual topic, but also the associated physical queues. To fix this, you should disable forwarding messages on the associated physical queues.</p>

<p>Here is an example of how to do that:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;networkConnectors&gt;
  &lt;networkConnector uri="static://(tcp://localhost:61617)"&gt;
    &lt;excludedDestinations&gt;
      &lt;queue physicalName="Consumer.*.VirtualTopic.&gt;"/&gt;
    &lt;/excludedDestinations&gt;
  &lt;/networkConnector&gt;
&lt;/networkConnectors&gt;
</code></pre></div></div>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2022, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
