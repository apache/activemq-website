<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Get Involved<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Ajax</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="connectivity">Connectivity</a> &gt; <a href="ajax">Ajax</a></p>

<h1 id="introduction">Introduction</h1>

<p>ActiveMQ supports <a href="http://en.wikipedia.org/wiki/Ajax_%28programming%29">Ajax</a> which is an Asychronous Javascript And Xml mechanism for real time web applications. This means you can create highly real time web applications taking full advantage of the publish/subscribe nature of ActiveMQ</p>

<p>Ajax allows a regular DHTML client (with JavaScript and a modern version 5 or later web browser) to send and receive messages over the web. Ajax support in ActiveMQ builds on the same basis as the <a href="rest">REST</a> connector for ActiveMQ which allows any web capable device to send or receive messages over JMS.</p>

<p>To see Ajax in action, try <a href="web-samples">running the examples</a></p>

<h1 id="the-servlet">The Servlet</h1>

<p>The AMQ AjaxServlet needs to be installed in your webapplications to support JMS over Ajax:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;servlet&gt;
  &lt;servlet-name&gt;AjaxServlet&lt;/servlet-name&gt;
  &lt;servlet-class&gt;org.apache.activemq.web.AjaxServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
...
&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;AjaxServlet&lt;/servlet-name&gt;
  &lt;url-pattern&gt;/amq/*&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre></div></div>
<p>The servlet both serves the required js files and handles the JMS requests and responses.</p>

<h1 id="javascript-api">Javascript API</h1>

<p>The ajax featues of amq are provided on the client side by the <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web-demo/src/main/webapp/js/amq.js">amq.js</a> script. Beginning with ActiveMQ 5.4, this script utilizes one of three different adapters to support ajax communication with the server. Current <a href="http://jquery.org">jQuery</a>, <a href="http://prototypejs.org">Prototype</a>, and <a href="http://www.dojotoolkit.org">Dojo</a> are supported, and recent versions of all three libraries are shipped with ActiveMQ.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script type="text/javascript" src="js/jquery-1.4.2.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="js/amq\_jquery\_adapter.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="js/amq.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
  var amq = org.activemq.Amq;
  amq.init({ 
    uri: 'amq', 
    logging: true,
    timeout: 20
  });
&lt;/script&gt;
</code></pre></div></div>
<p>Including these scripts results in the creation of a javascript object called <code class="language-plaintext highlighter-rouge">amq</code>, which provides the API to send messages and to subscribe to channels and topics.</p>

<h2 id="sending-a-message">Sending a message</h2>

<p>All that is required to send a JMS message from the javascript client, is to call the method:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amq.sendMessage(myDestination,myMessage);
</code></pre></div></div>
<p>where <code class="language-plaintext highlighter-rouge">myDestination</code> is the URL string address of the destination (e.g. <code class="language-plaintext highlighter-rouge">topic://MY.NAME</code> or <code class="language-plaintext highlighter-rouge">channel://MY.NAME</code>) and <code class="language-plaintext highlighter-rouge">myMessage</code> is any well formed XML or plain text encoded as XML content.</p>

<h2 id="receiving-messages">Receiving messages</h2>

<p>To receive messages, the client must define a message handling function and register it with the <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web-demo/src/main/webapp/js/amq.js">amq</a> object. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var myHandler =
{
  rcvMessage: function(message)
  {
     alert("received "+message);
  }
};

amq.addListener(myId,myDestination,myHandler.rcvMessage);
</code></pre></div></div>
<p>where <code class="language-plaintext highlighter-rouge">myId</code> is a string identifier that can be used for a later call to <code class="language-plaintext highlighter-rouge">amq.removeHandler(myId)</code> and <code class="language-plaintext highlighter-rouge">myDestination</code> is a URL string address of the destination (e.g. <code class="language-plaintext highlighter-rouge">topic://MY.NAME</code> or <code class="language-plaintext highlighter-rouge">channel://MY.NAME</code>). When a message is received, a call back to the <code class="language-plaintext highlighter-rouge">myHandler.rcvMessage</code> function passes the message to your handling code.<br />
The “message” is actually a text of the Text message or a String representation (<code class="language-plaintext highlighter-rouge">toString()</code>) in case of Object messages.</p>

<p>Be aware that, by default, messages published via <a href="stomp">Stomp</a> which include a <code class="language-plaintext highlighter-rouge">content-length</code> header will be converted by ActiveMQ to binary messages, and will not be visible to your web clients. Beginning with ActiveMQ 5.4.0, you can resolve this problem by always setting the <a href="https://issues.apache.org/jira/browse/AMQ-2833"><code class="language-plaintext highlighter-rouge">amq-msg-type</code> header</a> to <code class="language-plaintext highlighter-rouge">text</code> in messages which will may be consumed by web clients.</p>

<h3 id="selector-support">Selector support</h3>

<p>By default, an ajax client will receive all messages on a topic or queue it is subscribed to. In <a href="http://activemq.apache.orgOverview/Download/activemq-541-release">ActiveMQ 5.4.1</a> amq.js supports <a href="http://activemq.apache.orgFeatures/Consumer Features/selectors">JMS selectors</a> since it is frequently useful to receive only a subset of these messages. Selectors are supplied to an <code class="language-plaintext highlighter-rouge">amq.addListener</code> call by way of an optional 4th parameter.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>amq.addListener( myId, myDestination, myHandler.rcvMessage, { selector:"identifier='TEST'" } );
</code></pre></div></div>
<p>When used in this way, the Javascript client will receive only messages containing an <code class="language-plaintext highlighter-rouge">identifier</code> header set to the value <code class="language-plaintext highlighter-rouge">TEST</code>.</p>

<h2 id="using-amq-ajax-in-multiple-browser-windows">Using AMQ Ajax in Multiple Browser Windows</h2>

<p>All windows or tabs in a single browser share the same <code class="language-plaintext highlighter-rouge">JSESSIONID</code> on the ActiveMQ server. Unless the server can distinguish listeners from multiple windows, messages which were intended for 1 window will be delivered to another one instead. Effectively, this means that amq.js could be active in only a single browser window at any given time. Beginning in <a href="http://activemq.apache.orgOverview/DownloadOverview/Download/Overview/Download/activemq-542-release">ActiveMQ 5.4.2</a>, this is resolved by allowing each call to <code class="language-plaintext highlighter-rouge">amq.init</code> to specify a unique <code class="language-plaintext highlighter-rouge">clientId</code>. When this is done, multiple windows in the same browser can happily co-exist. Each can have a separate set of message subscriptions on the broker with no interactions between them.</p>

<p>In this example, we use the current time (at the time the web page is loaded) as a unique identifier. This is effective as long as two browser windows are not opened within the same millisecond, and is the approach used by the example <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web-demo/src/main/webappchat">chat.md</a> included with ActiveMQ. Other schemes to ensure the uniqueness of <code class="language-plaintext highlighter-rouge">clientId</code> can easily be devised. Note that this <code class="language-plaintext highlighter-rouge">clientId</code> need only be unique within a single session. (Browser windows opened in the same millisecond in separate browsers will not interact, since they are in different sessions.)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.activemq.Amq.init({
  uri: 'amq', 
  logging: true, 
  timeout: 45, 
  clientId:(new Date()).getTime().toString() 
});
</code></pre></div></div>
<p>Note that this <code class="language-plaintext highlighter-rouge">clientId</code> is common to all message subscriptions in a single tab or window, and is entirely different from the <code class="language-plaintext highlighter-rouge">clientId</code> which is supplied as a first argument in <code class="language-plaintext highlighter-rouge">amq.addListener</code> calls.</p>

<ul>
  <li>In <code class="language-plaintext highlighter-rouge">amq.init</code>, <code class="language-plaintext highlighter-rouge">clientId</code> serves to distinguish different web clients sharing the same <code class="language-plaintext highlighter-rouge">JSESSIONID</code>. All windows in a single browser need a unique <code class="language-plaintext highlighter-rouge">clientId</code> when they call <code class="language-plaintext highlighter-rouge">amq.init</code>.</li>
  <li>In <code class="language-plaintext highlighter-rouge">amq.addListener</code>, <code class="language-plaintext highlighter-rouge">clientId</code> is used to associate a message subscription with the callback function which should be invoked when a message is received for that subscription. These <code class="language-plaintext highlighter-rouge">clientId</code> values are internal to each web page, and do not need to be unique across multiple windows or tabs.</li>
</ul>

<h1 id="how-it-works">How it works</h1>

<h2 id="ajaxservlet-and-messagelistenerservlet">AjaxServlet and MessageListenerServlet</h2>

<p>The ajax featues of amq are handled on the server side by the <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web/src/main/java/org/apache/activemq/web/AjaxServlet.java">AjaxServlet</a> which extends the <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web/src/main/java/org/apache/activemq/web/MessageListenerServlet.java">MessageListenerServlet</a>. This servlet is responsible for tracking the existing clients (using a HttpSesssion) and lazily creating the AMQ and javax.jms objects required by the client to send and receive messages (eg. Destination, MessageConsumer, MessageAVailableListener). This servlet should be mapped to <code class="language-plaintext highlighter-rouge">/amq/*</code> in the web application context serving the Ajax client (this can be changed, but the client javascript <code class="language-plaintext highlighter-rouge">amq.uri</code> field needs to be updated to match.)</p>

<h2 id="client-sending-messages">Client Sending messages</h2>

<p>When a message is sent from the client it is encoded as the content of a POST request, using the API of one of the supported connection adapters (jQuery, Prototype, or Dojo) for <a href="http://jibbering.com/2002/4/httprequest.html">XmlHttpRequest</a>. The <a href="https://svn.apache.org/repos/asf/activemq/trunk/activemq-web-demo/src/main/webapp/js/amq.js">amq</a> object may combine several sendMessage calls into a single POST if it can do so without adding additional delays (see polling below).</p>

<p>When the MessageListenerServlet receives a POST, the messages are decoded as <code class="language-plaintext highlighter-rouge">application/x-www-form-urlencoded</code> parameters with their type (in this case <code class="language-plaintext highlighter-rouge">send</code> as opposed to <code class="language-plaintext highlighter-rouge">listen</code> or <code class="language-plaintext highlighter-rouge">unlisten</code> see below) and destination. If a destination channel or topic do not exist, it is created. The message is sent to the destination as a TextMessage.</p>

<h2 id="listening-for-messages">Listening for messages</h2>

<p>When a client registers a listener, a message subscription request is sent from the client to the server in a POST in the same way as a message, but with a type of <code class="language-plaintext highlighter-rouge">listen</code>. When the MessageListenerServlet receives a <code class="language-plaintext highlighter-rouge">listen</code> message, it lazily creates a MessageAvailableConsumer and registers a Listener on it.</p>

<h2 id="waiting-poll-for-messages">Waiting Poll for messages</h2>

<p>When a Listener created by the MessageListenerServlet is called to indicate that a message is available, due to the limitations of the HTTP client-server model, it is not possible to send that message directly to the ajax client. Instead the client must perform a special type of <strong>Poll</strong> for messages. Polling normally means periodically making a request to see if there are messages available and there is a trade off: either the poll frequency is high and excessive load is generated when the system is idle; or the frequency is low and the latency for detecting new messages is high.</p>

<p>To avoid the load vs latency tradeoff, AMQ uses a waiting poll mechanism. As soon as the amq.js script is loaded, the client begins polling the server for available messages. A poll request can be sent as a GET request or as a POST if there are other messages ready to be delivered from the client to the server. When the MessageListenerServlet receives a poll it:</p>

<ol>
  <li>if the poll request is a POST, all <code class="language-plaintext highlighter-rouge">send</code>, <code class="language-plaintext highlighter-rouge">listen</code> and <code class="language-plaintext highlighter-rouge">unlisten</code> messages are processed</li>
  <li>if there are no messages available for the client on any of the subscribed channels or topic, the servlet suspends the request handling until:
    <ul>
      <li>A MessageAvailableConsumer Listener is called to indicate that a message is now available; or</li>
      <li>A timeout expires (normally around 30 seconds, which is less than all common TCP/IP, proxy and browser timeouts).</li>
    </ul>
  </li>
  <li>A HTTP response is returned to the client containing all available messages encapsulated as <code class="language-plaintext highlighter-rouge">text/xml</code>.</li>
</ol>

<p>When the amq.js javascipt receives the response to the poll, it processes all the messages by passing them to the registered handler functions. Once it has processed all the messages, it immediately sends another poll to the server.</p>

<p>Thus the idle state of the amq ajax feature is a poll request “parked” in the server, waiting for messages to be sent to the client. Periodically this “parked” request is refreshed by a timeout that prevents any TCP/IP, proxy or browser timeout closing the connection. The server is thus able to asynchronously send a message to the client by waking up the “parked” request and allowing the response to be sent.</p>

<p>The client is able to asynchronously send a message to the server by creating (or using an existing) second connection to the server. However, during the processing of the poll response, normal client message sending is suspended, so that all messages to be sent are queued and sent as a single POST with the poll that will be sent (with no delay) at the end of the processing. This ensures that only two connections are required between client and server (the normal for most browsers).</p>

<h2 id="threadless-waiting">Threadless Waiting</h2>

<p>The waiting poll described above is implemented using the <a href="http://docs.codehaus.org/display/JETTY/Continuations">Jetty 6 Continuations</a> mechanism. This allows the thread associated with the request to be released during the wait, so that the container does not need to have a thread per client (which may be a large number). If another servlet container is used, the Continuation mechanism falls back to use a wait and the thread is not released.</p>

<h1 id="comparison-to-pushlets">Comparison to Pushlets</h1>

<p>Firstly we could easily add support for pushlets to ActiveMQ. However we prefer the Ajax approach for various reasons</p>

<ul>
  <li>using Ajax means that we use a distinct HTTP request for each send/receive which is much more friendly to web infrastructure (firewalls, proxies, caches and so forth) rather than having an infinitely-long GET.</li>
  <li>we can still take advantage of HTTP 1.1 keep-alive sockets and pipeline processing to gain the efficiency of a single socket used for communication between the client and server side; though in a way that works with any HTTP-capable infrastructure</li>
  <li>the server is pure REST and so will work with any client side (rather than being tied to custom JavaScript function calls used on the page which the Pushlet approach requires). So Pushlets tie the server to the web page; with Ajax we can have a generic service which works with any page.</li>
  <li>the client can be in control over frequency of polling &amp; timeouts. e.g. it can avoid the memory issues of Pushlets in some browsers by using a 20-second timeout HTTP GET. Or using a zero timeout GET to poll queues.</li>
  <li>its easier to take full advantage of HTTP encoding of messages, rather than using JavaScript function calls as the transfer protocol.</li>
  <li>pushlets assume the server knows what functions are used on the client side as the server basically writes JavaScript function calls down the scoket - it’s better for us to send generic XML packets (or strings or whatever the message format is) and let the JavaScript client side be totally decoupled from the server side</li>
  <li>Ajax supports clean XML support allowing full XML documents to be streamed to the client for rich messages which are easy to process via standard JavaScript DOM support</li>
</ul>

      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2021, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
