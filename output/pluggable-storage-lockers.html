<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="/js/fontawesome-v5.0.8-all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ"></script>
    <script src="/js/jquery-3.6.1.slim.min.js" integrity="sha384-MYL22lstpGhSa4+udJSGro5I+VfM13fdJfCbAzP9krCEoK5r2EDFdgTg2+DGXdj+"></script>
    <script src="/js/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"></script>
    <script src="/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/news">News</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ Classic</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Get Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://whimsy.apache.org/board/minutes/ActiveMQ.html">Board Reports</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Pluggable storage lockers</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="features">Features</a> &gt; <a href="persistence">Persistence</a> &gt; <a href="pluggable-storage-lockers">Pluggable storage lockers</a></p>

<p>As of the 5.7.0 release of ActiveMQ the choice of storage locking mechanism, as used by a persistence adapter, has been made pluggable. This feature is only meaningful to brokers configured in a shared storage master/slave topology. Prior to release 5.7.0 the storage locking mechanism (and thus master election) was dictated by the choice of persistence adapter. With the KahaDB persistence adapter, for example, the storage locking mechanism was based on a shared file lock. Similarly, the JDBC persistence adapter used a database backed storage lock.</p>

<p>Now that the choice of storage locker is divorced from that of the persistence adapter one can mix and match combinations of the two. Storage locker pluggability is made possible by the <a href="https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-broker/src/main/java/org/apache/activemq/broker/Locker.java?hb=true">Locker</a> interface that all pluggable lockers must implement. This interface makes it easy to implement a custom storage locker that meets local requirements.</p>

<p>Every persistence adapter, however, has its own default locker which works as before.</p>

<h2 id="lockers">Lockers</h2>

<p>Every locker must implement the <a href="https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-broker/src/main/java/org/apache/activemq/broker/Locker.java?hb=true">Locker</a> interface. The locker interface has the following properties:</p>

<table>
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Default Value</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval</code></td>
      <td><code class="language-plaintext highlighter-rouge">10000</code></td>
      <td>The polling interval (in milliseconds) between lock acquire attempts.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">failIfLocked</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td>Should the broker start fail if the lock is not immediately available. When <code class="language-plaintext highlighter-rouge">true</code> slave brokers will not start.</td>
    </tr>
  </tbody>
</table>

<h2 id="persistence-adapters">Persistence Adapters</h2>

<p>Every persistence adapter (or any other broker service that wishes to use locks) must implement the <a href="https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-broker/src/main/java/org/apache/activemq/broker/Lockable.java?r=1383400">Lockable</a> interface. This interface has the following properties:</p>

<table>
  <thead>
    <tr>
      <th>Property Name</th>
      <th>Default Value</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">useLock</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td>Should the persistence adapter use the configured locker. Intended primarily for use during development to temporarily disable the use of the locker without having to remove its configuration.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code></td>
      <td><code class="language-plaintext highlighter-rouge">0</code></td>
      <td>The duration (in milliseconds) to keep the lock alive, when greater than <code class="language-plaintext highlighter-rouge">0</code>.</td>
    </tr>
  </tbody>
</table>

<h2 id="existing-lockers">Existing Lockers</h2>

<h3 id="shared-file-locker">Shared File Locker</h3>

<p>The Shared File Locker is the default locker for the KahaDB persistence adapter. It locks a file to ensure that only the broker holding the lock (the master) is granted access to the message store.</p>

<h4 id="example">Example:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;persistenceAdapter&gt;
	&lt;kahaDB directory="target/activemq-data" lockKeepAlivePeriod="10000"&gt;
		&lt;locker&gt;
			&lt;shared-file-locker lockAcquireSleepInterval="5000"/&gt;
		&lt;/locker&gt;
	&lt;/kahaDB&gt;
&lt;/persistenceAdapter&gt;
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> attribute is not applicable to versions of ActiveMQ older than 5.9.0.</p>

<blockquote>
  <p>Consequences of lockKeepAlivePeriod = 0</p>

  <p>For this locker <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> should be greater than <code class="language-plaintext highlighter-rouge">0</code>.This period is the frequency with which the master broker makes lock keep alive calls.</p>

  <p>When <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod = 0</code> slave brokers are still unable to obtain the file lock. However, if some third party modifies the lock file (either modification or deletion) the master broker will not detect the change. Therefore a slave broker’s next attempt (per its configured <code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval</code>) to obtain the file lock will succeed. When this happens there will be two master brokers in the cluster. <em>This situation will result in message store corruption</em>!</p>

  <p>When <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> is greater than <code class="language-plaintext highlighter-rouge">0</code>, the master broker will make a lock keep alive call every <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> milliseconds. Therefore the master broker will detect any lock file changes when it makes its next keep alive call. Upon detecting said change the master broker will demote itself to a slave broker.</p>
</blockquote>

<blockquote>
  <p>Note that as of ActiveMQ 5.9.0 the KahaDB persistence adapter can also use the Lease Database Locker (see below).</p>
</blockquote>

<h3 id="database-locker">Database Locker</h3>

<p>The Database Locker is the default locker for the JDBC persistence adapter. It locks a database table in a transaction to ensure that only single resource is used.</p>

<h4 id="example-1">Example:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;persistenceAdapter&gt;
    &lt;jdbcPersistenceAdapter dataDirectory="${activemq.data}" dataSource="#mysql-ds" lockKeepAlivePeriod="10000"&gt;
        &lt;locker&gt;
            &lt;database-locker lockAcquireSleepInterval="5000"/&gt;
        &lt;/locker&gt;
    &lt;/jdbcPersistenceAdapter&gt;
&lt;/persistenceAdapter&gt;
</code></pre></div></div>

<p>The Database Locker uses its <code class="language-plaintext highlighter-rouge">keepAlive</code> method to ensure the broker still holds the lock. You can set the keep alive period using the <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> property. The default period is 30000 ms. If a broker fails to acquire the lock on the database, it will retry every <code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval</code> milliseconds.</p>

<p>This locker opens a JDBC transaction against a database table (<code class="language-plaintext highlighter-rouge">activemq_lock</code>) that lasts as long as the broker remains alive. This locks the entire table and prevents another broker from accessing the store. In most cases this will be a fairly long running JDBC transaction which occupies resources on the database over time.</p>

<p>A problem with this locker can arise when the master broker crashes or loses its connection to the database causing the lock to remain in the database until the database responds to the half closed socket connection via a TCP timeout. The database lock expiry requirement can prevent the slave from starting some time. In addition, if the database supports failover, and the connection is dropped in the event of a replica failover, that JDBC transaction will be rolled back. The broker sees this as a failure. Both master and slave brokes will again compete for a lock.</p>

<h3 id="lease-database-locker">Lease Database Locker</h3>

<p>The Lease Database Locker was created to solve the shortcomings of the Database Locker. The Lease Database Locker does not open a long running JDBC transaction. Instead it lets the master broker acquire a lock that’s valid for a fixed (usually short) duration after which it expires. To retain the lock the master broker must periodically extend the lock’s lease before it expires. Simultaneously the slave broker checks periodically to see if the lease has expired. If, for whatever reason, the master broker fails to update its lease on the lock the slave will take ownership of the lock becoming the new master in the process. The leased lock can survive a DB replica failover.</p>

<h4 id="example-2">Example:</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;persistenceAdapter&gt;
	&lt;jdbcPersistenceAdapter dataDirectory="${activemq.data}" dataSource="#mysql-ds" lockKeepAlivePeriod="5000"&gt;
		&lt;locker&gt;
			&lt;lease-database-locker lockAcquireSleepInterval="10000"/&gt;
		&lt;/locker&gt;
	&lt;/jdbcPersistenceAdapter&gt;
&lt;/persistenceAdapter&gt;
</code></pre></div></div>

<p>In order for this mechanism to work correctly, each broker in a master/slave(s) cluster must have a unique value for the <code class="language-plaintext highlighter-rouge">brokerName</code> attribute as defined on the <code class="language-plaintext highlighter-rouge">&lt;broker/&gt;</code> tag. Alternatively, use unique values for the <code class="language-plaintext highlighter-rouge">leaseHolderId</code> attribute on the <code class="language-plaintext highlighter-rouge">&lt;lease-database-locker/&gt;</code> tag as this value is used to create a lease lock definition.</p>

<p>The lease based lock is acquired by blocking at startup. It is then retained for a period whose duration (in ms) is given by the <code class="language-plaintext highlighter-rouge">lockKeepAlivePeriod</code> attribute. To retain the lock the master broker periodically extends its lease by <code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval</code> milliseconds each time. In theory, therefore, the master broker is always (<code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval - lockKeepAlivePeriod</code>) ahead of the slave broker with regard to the lease. It is imperative that <code class="language-plaintext highlighter-rouge">lockAcquireSleepInterval &gt; lockKeepAlivePeriod</code>, to ensure the lease is always current. As of ActiveMQ 5.9.0 a warning message is logged if this condition is not met.</p>

<p>In the simplest case, the clocks between master and slave must be in sync for this solution to work properly. If the clocks cannot be in sync, the locker can use the system time from the database CURRENT TIME and adjust the timeouts in accordance with their local variance from the DB system time. If <code class="language-plaintext highlighter-rouge">maxAllowableDiffFromDBTime</code> is greater than zero the local periods will be adjusted by any delta that exceeds <code class="language-plaintext highlighter-rouge">maxAllowableDiffFromDBTime</code>.</p>

<blockquote>
  <p>It is important to know if the default rules your JDBC driver uses for converting <code class="language-plaintext highlighter-rouge">TIME</code> values are JDBC compliant. If you’re using MySQL, for example, the driver’s JDBC URL should contain <code class="language-plaintext highlighter-rouge">useJDBCCompliantTimezoneShift=true</code> to ensure that <code class="language-plaintext highlighter-rouge">TIME</code> value conversion is JDBC compliant. If not the locker could report a large time difference when it compares the retrieved lease expiration time against the current system time. Consult your JDBC driver’s documentation for more details.</p>
</blockquote>

<p>As of ActiveMQ 5.9.0 the lease database locker can be used in conjunction with the KahaDB persistence adapter. However, this particular combination requires that the lease database locker element contains a <code class="language-plaintext highlighter-rouge">&lt;statements/&gt;</code> child element. In the example below the <code class="language-plaintext highlighter-rouge">lockTableName</code> is also configured, although doing so is not mandatory.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;persistenceAdapter&gt;
	&lt;kahaDB directory="target/activemq-data" lockKeepAlivePeriod="5000"&gt;
		&lt;locker&gt;
            &lt;!\-\- When used with the KahaDB persistence adapter the 'dataSource' attribute must be defined on the locker itself: --&gt;
            &lt;lease-database-locker lockAcquireSleepInterval="10000" dataSource="#mysql-ds"&gt;
                &lt;statements&gt;
                    &lt;!\-\- Default locker attributes and SQL statements may be overridden here 
                         using one or more &lt;statements attribute\_or\_statement="value"/&gt; entries: --&gt;  
                    &lt;statements lockTableName="activemq_lock"/&gt;
                &lt;/statements&gt;
            &lt;/lease-database-locker&gt;
		&lt;/locker&gt;
	&lt;/kahaDB&gt;
&lt;/persistenceAdapter&gt;
</code></pre></div></div>
<blockquote>
  <p>To see the complete list of attributes and SQL statements that can be overridden see the <a href="https://fisheye6.atlassian.com/browse/activemq/trunk/activemq-jdbc-store/src/main/java/org/apache/activemq/store/jdbc/Statements.java?hb=true">Statements</a> class.</p>
</blockquote>

<p>When the KahaDB persistence adapter is configured to use the <code class="language-plaintext highlighter-rouge">lease-database-locker</code> you must configure the broker to use your own IO exception handler as neither the <code class="language-plaintext highlighter-rouge">DefaultIOExceptionHandler</code> nor the <code class="language-plaintext highlighter-rouge">JDBCIOExceptionHandler</code> will work correctly with this combination. See <a href="configurable-ioexception-handling">Configurable IOException Handlers</a> for details on how to write a handler.</p>

<blockquote>
  <p>As of ActiveMQ 5.11, however, the <code class="language-plaintext highlighter-rouge">JDBCIOExceptionHandler</code> has been deprecated. It has been replaced by the <code class="language-plaintext highlighter-rouge">org.apache.activemq.util.LeaseLockerIOExceptionHandler</code> that will work with any persistence adapter that supports pluggable storage lockers, regardless if one is configured.</p>
</blockquote>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2023, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
