<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Shiro</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="features">Features</a> &gt; <a href="security">Security</a> &gt; <a href="shiro">Shiro</a></p>

<p>ActiveMQ 5.10 and later provides a fully customizable security experience using <a href="http://shiro.apache.org">Apache Shiro</a>.</p>

<p>The ActiveMQ Shiro plugin can secure the ActiveMQ broker, from authenticating transport connections to authorizing behavior with topics and queues and everything in between.</p>

<h2 id="quickstart">Quickstart</h2>

<p>The fastest/simplest way to enable the ShiroPlugin is to define it as a Spring bean in the <code class="language-plaintext highlighter-rouge">broker</code> <code class="language-plaintext highlighter-rouge">plugins</code> section and embed <a href="http://shiro.apache.orgCommunity/FAQ/configuration">Shiro ini configuration</a>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:amq="http://activemq.apache.org/schema/core"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"&gt;

    &lt;broker xmlns="http://activemq.apache.org/schema/core" ... other attributes here ...&gt;
        &lt;plugins&gt;
            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="iniConfig"&gt;&lt;value&gt;

                [main]
                # Shiro object graph configuration here if desired/necessary

                [users]
                # users section format:
                #
                # username = password [, assignedRole1, assignedRole2, ..., assignedRoleN]
                #
                # for example:
                #
                # scott = tiger, advisory, users, administrators
                #
                # Roles and permissions assigned to roles are defined in the [roles] section
                # below. By transitive association, any user assigned a role is granted the
                # role's permissions.
                
                # ActiveMQ System User
                # needed for in-VM/local connections when authentication is enabled:
                system = manager, system
                
                # Other users here.  You should almost always add the \`advisory\` role for each
                # user to make your life easy!  See the [roles] comments below for more info.
                # jsmith = jsmithsPassword, advisory
                # djones = djonesPassword, advisory, ...
                # etc.

                [roles]
                # roles section format:
                #
                # roleName = wildcardPermission1, wildcardPermission2, ..., wildcardPermissionN
                #
                # The 'system' role is assigned all permissions (*).  Be careful when assigning
                # this to actual users other than then system user:
                system = *

                # Full access rights should generally be given to the ActiveMQ.Advisory.*
                # destinations because by default an ActiveMQConnection uses advisory topics to
                # get early knowledge of temp destination creation and deletion. For more info:
                #
                #   http://activemq.apache.org/Features/security.md
                #
                # So we create an 'advisory' role here with a wildcard/catch-all permissions
                # for all advisory topics.  To make your life easy, ensure you assign this to
                # any/all users in the [users] section above, e.g.
                #
                #   jsmith = jsmithsPassword, advisory, ...

                advisory = topic:ActiveMQ.Advisory*

                &lt;/value&gt;&lt;/property&gt;
            &lt;/bean&gt;
        &lt;/plugins&gt;
    &lt;/broker&gt;
&lt;/beans&gt;
</code></pre></div></div>
<p>This config assumes you have a simple/small set of static users that access your ActiveMQ broker. We’ll cover enabling more advanced user repositories later.</p>

<h4 id="encrypted-passwords">Encrypted Passwords</h4>

<p>The above example uses plaintext passwords, which is simple to set up and easy to use for testing, but not really secure. Most production deployments will likely want to use encrypted passwords. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- enabled by default.  To disable, uncomment:
    &lt;property name="iniConfig"&gt;&lt;value&gt;

    [main]
    # Shiro object graph configuration here
    passwordMatcher = org.apache.shiro.authc.credential.PasswordMatcher
    iniRealm.credentialsMatcher = $passwordMatcher
 
    [users]
    scott = $shiro1$SHA-256$500000$eWpVX2tGX7WCP2J+jMCNqw==$it/NRclMOHrfOvhAEFZ0mxIZRdbcfqIBdwdwdDXW2dM=, advisory
    system = $shiro1$SHA-256$500000$eUyGwMGr9GYzB/gg/MoNgw==$WGc0yWFWv8+hLqjzVLgW7Hat2FQTywDXBl5izpqaLSY=, system

    [roles]
    system = *
    advisory = topic:ActiveMQ.Advisory*
    &lt;/value&gt;&lt;/property&gt;
&lt;/bean&gt;
</code></pre></div></div>
<p>As you can see, two things are different than the simpler/default configuration:</p>

<ol>
  <li>The <code class="language-plaintext highlighter-rouge">[main]</code> section configured a <code class="language-plaintext highlighter-rouge">PasswordMatcher</code> on the implicit <code class="language-plaintext highlighter-rouge">iniRealm</code>. This indicates that all <code class="language-plaintext highlighter-rouge">.ini</code>-configured users are expected to have proper hashed/secure passwords.</li>
  <li>The <code class="language-plaintext highlighter-rouge">[users]</code> lines now have hash values in the <code class="language-plaintext highlighter-rouge">password</code> location instead of plaintext values.</li>
</ol>

<p>To get the hashed password text values, you will want to <a href="http://search.maven.org/remotecontent?filepath=org/apache/shiro/tools/shiro-tools-hasher/1.2.2/shiro-tools-hasher-1.2.2-cli.jar">Download Shiro’s Command Line Hasher</a> from Maven Central. Once downloaded, you can use it to create secure password hashes that you can safely copy-and-paste in to the <code class="language-plaintext highlighter-rouge">[users]</code> section:</p>

<p>$ java -jar shiro-tools-hasher-X.X.X-cli.jar -p</p>

<p>It will then ask you to enter the password and then confirm it:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Password to hash:
Password to hash (confirm):
</code></pre></div></div>
<p>When this command executes, it will print out the securely-salted-iterated-and-hashed password. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$shiro1$SHA-256$500000$eWpVX2tGX7WCP2J+jMCNqw==$it/NRclMOHrfOvhAEFZ0mxIZRdbcfqIBdwdwdDXW2dM=
</code></pre></div></div>
<p>Take this value and place it as the password in the user definition line (followed by any desired roles, such as the <code class="language-plaintext highlighter-rouge">advisory</code> role). For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[users]
scott = $shiro1$SHA-256$500000$eWpVX2tGX7WCP2J+jMCNqw==$it/NRclMOHrfOvhAEFZ0mxIZRdbcfqIBdwdwdDXW2dM=, advisory
system = $shiro1$SHA-256$500000$eUyGwMGr9GYzB/gg/MoNgw==$WGc0yWFWv8+hLqjzVLgW7Hat2FQTywDXBl5izpqaLSY=, system
</code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<p>The ActiveMQ Shiro plugin can be configured in a number of ways. For example, with Java:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BrokerService brokerService = new BrokerService();

ShiroPlugin shiroPlugin = new ShiroPlugin();
//configure shiroPlugin via getters/setters here

broker.setPlugins(new BrokerPlugin[]{shiroPlugin});
//continue configuring the brokerService as necessary ...
</code></pre></div></div>
<p>Or, if using traditional ActiveMQ xml, as a Spring bean in the <code class="language-plaintext highlighter-rouge">broker</code> <code class="language-plaintext highlighter-rouge">plugins</code> section. For example:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:amq="http://activemq.apache.org/schema/core"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd"&gt;

    &lt;broker xmlns="http://activemq.apache.org/schema/core" ... other attributes here ...&gt;

        &lt;plugins&gt;
    
            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;!-- Config properties via getters/setters as necessary: --&gt;
            &lt;/bean&gt;

        &lt;/plugins&gt;

    &lt;/broker&gt;
&lt;/beans&gt;
</code></pre></div></div>
<p>The remaining configuration examples on this page will be shown as bean XML, but know that the same configuration can be done in Java as standard JavaBeans-compatible getter and setter methods.</p>

<h3 id="enablingdisabling">Enabling/Disabling</h3>

<p>You can enable or disable the ShiroPlugin entirely without having to remove it from your configuration. This is convenient when testing, or when you want to enable or disable it based on a configuration parameter at startup.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
    &lt;!-- enabled by default.  To disable, uncomment:
    &lt;property name="enabled" value="false"/&gt; --&gt;
&lt;/bean&gt;
</code></pre></div></div>
<p>A nice technique is to use Spring’s <a href="http://static.springsource.org/spring/docs/3.2.x/javadoc-api/org/springframework/context/support/PropertySourcesPlaceholderConfigurer.html">PropertySourcesPlaceholderConfigurer</a> and placeholder tokens (set <code class="language-plaintext highlighter-rouge">shiro.enabled = true</code> in one of your placeholder property files):</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans ...&gt;

    &lt;bean class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer"&gt;
       ...
    &lt;/bean&gt;

    &lt;broker ...&gt;
        &lt;plugins ...&gt;

            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="enabled" value="${shiro.enabled}"/&gt;
            &lt;/bean&gt;
 
        &lt;/plugins&gt;
    &lt;/broker&gt;
&lt;/beans&gt;
</code></pre></div></div>
<p>This allows you to enable or disable the Shiro plugin by simply setting a property in a <code class="language-plaintext highlighter-rouge">.properties</code> file without having to change your XML config.</p>

<h3 id="shiro-environment">Shiro Environment</h3>

<p>The <code class="language-plaintext highlighter-rouge">shiroPlugin</code> requires a Shiro <a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/env/Environment.html">Environment</a> to function. You must either configure the plugin with:</p>

<ul>
  <li>an <code class="language-plaintext highlighter-rouge">Environment</code> instance (or a Shiro <code class="language-plaintext highlighter-rouge">SecurityManager</code> instance) that you instantiate and configure elsewhere - e.g. in Java code or elsewhere in the Spring XML config, or</li>
  <li>specify some Shiro <a href="http://shiro.apache.orgCommunity/FAQ/configuration">.ini configuration</a>, either as a direct String, an <a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/config/Ini.html">Ini</a> instance, or a <a href="http://shiro.apache.org/static/current/apidocs/org/apache/shiro/io/ResourceUtils.html#getInputStreamForPath(java.lang.String)">resource path</a> where your <code class="language-plaintext highlighter-rouge">shiro.ini</code> file is located. The plugin will load the ini config and create an <code class="language-plaintext highlighter-rouge">Environment</code> automatically.</li>
</ul>

<h4 id="custom-environment">Custom Environment</h4>

<p>A Shiro <code class="language-plaintext highlighter-rouge">Environment</code> object contains everything that Shiro needs to operate, and this encapsulates the Shiro <code class="language-plaintext highlighter-rouge">SecurityManager</code> as well. If you want to construct and configure an Environment instance yourself:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans ...&gt;
    &lt;broker ...&gt;
        &lt;plugins&gt;
        
            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="environment" ref="shiroEnvironment"/&gt;
            &lt;/bean&gt;
 
        &lt;/plugins&gt;
    &lt;/broker&gt;

    &lt;bean id="shiroEnvironment" class=".."&gt;
        ... config here ...
    &lt;/bean&gt;
    &lt;bean class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/&gt;

&lt;/beans&gt;
</code></pre></div></div>

<h4 id="custom-securitymanager">Custom SecurityManager</h4>

<p>Instead of configuring an <code class="language-plaintext highlighter-rouge">Environment</code> instance, you can construct a <code class="language-plaintext highlighter-rouge">SecurityManager</code> instead:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans ...&gt;
    &lt;broker ...&gt;
        &lt;plugins&gt;
        
            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="securityManager" ref="shiroSecurityManager"/&gt;
            &lt;/bean&gt;
 
        &lt;/plugins&gt;
    &lt;/broker&gt;

    &lt;bean id="shiroSecurityManager" class="org.apache.shiro.mgt.DefaultSecurityManager"&gt;
        &lt;property name="realms"&gt;
            &lt;list&gt;
                &lt;bean id="myRealm" class="..."&gt;
                    ...
                &lt;/bean&gt;
                ... maybe more Realm beans ...
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/&gt;

&lt;/beans&gt;
</code></pre></div></div>
<p>If specifying a <code class="language-plaintext highlighter-rouge">SecurityManager</code> instead of the <code class="language-plaintext highlighter-rouge">Environment</code> property, an <code class="language-plaintext highlighter-rouge">Environment</code> will be created automatically that wraps the configured <code class="language-plaintext highlighter-rouge">SecurityManager</code>.</p>

<h4 id="shiroini-file">shiro.ini File</h4>

<p>If you don’t want to construct a <code class="language-plaintext highlighter-rouge">SecurityManager</code> or <code class="language-plaintext highlighter-rouge">Environment</code> in code or xml, you can easily specify a <a href="http://shiro.apache.orgCommunity/FAQ/configuration">shiro.ini</a> file instead and an Environment/SecurityManager will automatically be created based on that:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans ...&gt;
    &lt;broker ...&gt;
        &lt;plugins&gt;

            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="iniResourcePath" value="classpath:myshiro.ini"/&gt;
            &lt;/bean&gt;

        &lt;/plugins&gt;
    &lt;/broker&gt;
&lt;/beans&gt;
</code></pre></div></div>
<p>This allows you to keep your Shiro config separate from your ActiveMQ broker configuration if you prefer.</p>

<h4 id="shiroini-embedded">shiro.ini Embedded</h4>

<p>If you want to use ini configuration and you would prefer to have all configuration in one place, you can embed the ini config instead:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;beans ...&gt;
    &lt;broker ...&gt;
        &lt;plugins ...&gt;
        
            &lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
                &lt;property name="iniConfig"&gt;
                    &lt;value&gt;
                    [main]

                    # Shiro object graph configuration here if desired/necessary

                    [users]
                    system = manager, system

                    [roles]
                    system = *
                    advisory = topic:ActiveMQ.Advisory*
                    &lt;/value&gt;
                &lt;/property&gt;
            &lt;/bean&gt;

        &lt;/plugins&gt;
    &lt;/broker&gt;
&lt;/beans&gt;
</code></pre></div></div>

<h2 id="design">Design</h2>

<p>The Shiro plugin is a <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/broker/BrokerPlugin.html">BrokerPlugin</a> that inserts 3 <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/broker/BrokerFilter.html">BrokerFilter</a>s in the broker filter chain: the <code class="language-plaintext highlighter-rouge">SubjectFilter</code>, the <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> and the <code class="language-plaintext highlighter-rouge">AuthorizationFilter</code></p>

<p><strong>SubjectFilter</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">SubjectFilter</code> exists before all other Shiro-related broker filters in the broker filter chain. It constructs a Shiro <a href="http://shiro.apache.org/subject.html">Subject</a> instance reflecting the broker client and ensures the <code class="language-plaintext highlighter-rouge">Subject</code> instance is available for all downstream broker filters that may need to use the <code class="language-plaintext highlighter-rouge">Subject</code> to perform security operations.</p>

<p><strong>AuthenticationFilter</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> exists immediately after the <code class="language-plaintext highlighter-rouge">SubjectFilter</code> in the broker filter chain. It ensures that the broker client <code class="language-plaintext highlighter-rouge">Subject</code> is authenticated if necessary before allowing the chain to continue. If authentication is required and the <code class="language-plaintext highlighter-rouge">Subject</code> is not authenticated, the broker filter chain will not be executed, ensuring only verified identities may perform further behavior.</p>

<p><strong>AuthorizationFilter</strong></p>

<p>The <code class="language-plaintext highlighter-rouge">AuthorizationFilter</code> exists immediately after the <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> in the broker filter chain. It ensures that the <code class="language-plaintext highlighter-rouge">Subject</code> associated with the filter chain is authorized (permitted) to perform the action being attempted before allowing the action to execute.</p>

<p>For example, it would ensure that the <code class="language-plaintext highlighter-rouge">Subject</code> is allowed to send a message to a particular topic before allowing the send operation to execute. If authorization is enabled and the <code class="language-plaintext highlighter-rouge">Subject</code> is not authorized to perform the desired action, the broker filter chain will not be executed.</p>

<h2 id="subjectfilter">SubjectFilter</h2>

<p>The ShiroPlugin installs and executes the <code class="language-plaintext highlighter-rouge">SubjectFilter</code> before all other Shiro-related broker filters in the broker filter chain. The <code class="language-plaintext highlighter-rouge">SubjectFilter</code> constructs a Shiro <a href="http://shiro.apache.org/subject.html">Subject</a> instance reflecting the broker client and ensures the <code class="language-plaintext highlighter-rouge">Subject</code> instance is available for all downstream broker filters that may need to use the <code class="language-plaintext highlighter-rouge">Subject</code> to perform security operations.</p>

<p>The <code class="language-plaintext highlighter-rouge">SubjectFilter</code> is mostly a ‘behind the scenes’ component of the SubjectFilter, but it does offer some customization for advanced use cases:</p>

<ul>
  <li>the ability to customize exactly how broker clients’ <code class="language-plaintext highlighter-rouge">Subject</code> instances are created via a <code class="language-plaintext highlighter-rouge">ConnectionSubjectFactory</code> and</li>
  <li>the ability to customize how the ActiveMQ ConnectionContext’s <a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/security/SecurityContext.html">SecurityContext</a> is constructed.</li>
</ul>

<p>Unless you’re deeply familiar with ActiveMQ’s security model, you can safely skip to <strong>Authentication</strong> below.</p>

<h3 id="connectionsubjectfactory">ConnectionSubjectFactory</h3>

<p>A <code class="language-plaintext highlighter-rouge">ConnectionSubjectFactory</code> creates a <code class="language-plaintext highlighter-rouge">Subject</code> instance that represents the broker client’s identity. The <code class="language-plaintext highlighter-rouge">SubjectFilter</code>’s default instance is a <code class="language-plaintext highlighter-rouge">DefaultConnectionSubjectFactory</code></p>

<p>Most <code class="language-plaintext highlighter-rouge">ConnectionSubjectFactory</code> implementations will simply use Shiro’s <code class="language-plaintext highlighter-rouge">Subject.Builder</code> to create an anonymous Subject instance and let the downstream <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> authenticate the Subject based on any credentials associated with the connection. After authentication, the Subject will have an identity, and this is the expected flow for most connection clients.</p>

<p>However, if there is some other data associated with the connection that can be inspected to create a Subject instance beyond what the <code class="language-plaintext highlighter-rouge">DefaultConnectionSubjectFactory</code>, you can implement the <code class="language-plaintext highlighter-rouge">ConnectionSubjectFactory</code> interface and plug it in to the <code class="language-plaintext highlighter-rouge">SubjectFilter</code>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
    &lt;property name="subjectFilter.connectionSubjectFactory"&gt;
        &lt;bean class="com.my.ConnectionSubjectFactory" .../&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre></div></div>

<h3 id="securitycontextfactory">SecurityContextFactory</h3>

<p>The ActiveMQ <code class="language-plaintext highlighter-rouge">ConnectionContext</code> associated with broker client connections utilizes a <code class="language-plaintext highlighter-rouge">SecurityContext</code> object. When the <code class="language-plaintext highlighter-rouge">SubjectFilter</code> executes, it needs to create a Shiro-specific <code class="language-plaintext highlighter-rouge">SecurityContext</code> and associate it with the <code class="language-plaintext highlighter-rouge">ConnectionContext</code> so the Subject may be accessed downstream for all subsequent security operations.</p>

<p>The <code class="language-plaintext highlighter-rouge">SubjectFilter</code> delegates <code class="language-plaintext highlighter-rouge">SecurityContext</code> creation to a <code class="language-plaintext highlighter-rouge">SecurityContextFactory</code> instance. The <code class="language-plaintext highlighter-rouge">DefaultSecurityContextFactory</code> implementation returns <code class="language-plaintext highlighter-rouge">SubjectSecurityContext</code> instances based on the connection’s associated <code class="language-plaintext highlighter-rouge">Subject</code>. It should be an extremely rare thing to change, but if you must configure a custom <code class="language-plaintext highlighter-rouge">SecurityContextFactory</code>, you can do as follows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;bean id="shiroPlugin" class="org.apache.activemq.shiro.ShiroPlugin" xmlns="http://www.springframework.org/schema/beans"&gt;
    &lt;property name="subjectFilter.securityContextFactory"&gt;
        &lt;bean class="com.my.SecurityContextFactory" .../&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre></div></div>
<p>Note however that much of the plugin’s functionality and downstream filters expect created <code class="language-plaintext highlighter-rouge">SecurityContext</code> instances to be <code class="language-plaintext highlighter-rouge">SubjectSecurityContext</code> instances.</p>

<h2 id="authentication">Authentication</h2>

<p>The ShiroPlugin installs the <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> immediately after the <code class="language-plaintext highlighter-rouge">SubjectFilter</code> in the broker filter chain. The <code class="language-plaintext highlighter-rouge">AuthenticationFilter</code> ensures that the broker client <code class="language-plaintext highlighter-rouge">Subject</code> is authenticated if necessary before allowing the chain to continue. If authentication is required and the <code class="language-plaintext highlighter-rouge">Subject</code> is not authenticated, the broker filter chain will not be executed, ensuring only verified identities may perform further behavior.</p>

<p>WORK IN PROGRESS - STILL AUTHORING</p>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2021, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
