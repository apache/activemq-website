<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="/js/fontawesome-v5.0.8-all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ"></script>
    <script src="/js/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"></script>
    <script src="/js/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"></script>
    <script src="/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/news">News</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Get Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://whimsy.apache.org/board/minutes/ActiveMQ.html">Board Reports</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Apollo 1.7.1 Extending Guide</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <ul>
  <li><a href="index.html">Apollo 1.7.1</a></li>
  <li><a href="communitydevelopers">Developers</a></li>
  <li><a href="community/index.html">Community</a></li>
  <li><a href="..OverviewOverview/Overview/download">Download</a></li>
</ul>

<h1 id="apollo-171-extending-guide">Apollo 1.7.1 Extending Guide</h1>

<ul>
  <li><a href="#Overview">Overview</a></li>
  <li>
    <ul>
      <li><a href="#Adding_your_Extensions_to_the_Apollo_Class_Path">Adding your Extensions to the Apollo Class Path</a></li>
      <li><a href="#Extension_Discovery">Extension Discovery</a></li>
      <li><a href="#Extending_the_Data_Model">Extending the Data Model</a></li>
      <li>
        <ul>
          <li><a href="#Polymorphic_Data_Configuraiton_objects_Objects">Polymorphic Data/Configuraiton objects Objects</a></li>
        </ul>
      </li>
      <li><a href="#Using_a_custom__code_VirtualHost__code__implementation">Using a custom <code class="language-plaintext highlighter-rouge">VirtualHost</code> implementation</a></li>
      <li><a href="#Plugging_into_the_Broker_Lifecycle">Plugging into the Broker Lifecycle</a></li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>Apollo support being extended in several ways. This guide documents all the supported extension points.</p>

<h3 id="adding-your-extensions-to-the-apollo-class-path">Adding your Extensions to the Apollo Class Path</h3>

<p>Just create a <code class="language-plaintext highlighter-rouge">.jar</code> out of out code and add it to the <code class="language-plaintext highlighter-rouge">${apollo.home}/lib</code> directory. When Apollo restarts it will add the new jar to it’s class path.</p>

<h3 id="extension-discovery">Extension Discovery</h3>

<p>Apollo discovers your extensions by looking for extension resource files in all the jar files in it’s classpath. For example, the <code class="language-plaintext highlighter-rouge">apollo-broker</code> jar file contains the following a resource file <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/protocol-codec-factory.index</code> It contains the class names of the protocol codec factories that are implemented in the <code class="language-plaintext highlighter-rouge">broker-core</code> module. It’s contents are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.apache.activemq.apollo.broker.protocol.AnyProtocolFactory
org.apache.activemq.apollo.broker.protocol.UdpProtocolFactory
org.apache.activemq.apollo.broker.protocol.RawProtocolFactory
</code></pre></div></div>

<p>All three of the the listed classes implement the <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.protocol.ProtocolFactory"><code class="language-plaintext highlighter-rouge">ProtocolFactory</code></a> interface. Here’s a list of extension points supported by Apollo:</p>

<ul>
  <li>
    <p>Data Model: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/dto-module.index</code> → <a href="api/apollo-util/index.html#org.apache.activemq.apollo.util.DtoModule"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.util.DtoModule</code></a></p>
  </li>
  <li>
    <p>Transports: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/transport-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.transport.TransportFactory$$Provider"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.transport.TransportFactory.Provider</code></a></p>
  </li>
  <li>
    <p>Protocols: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/protocol-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.protocol.ProtocolFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.protocol.ProtocolFactory</code></a></p>
  </li>
  <li>
    <p>Broker Factories: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/broker-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.BrokerFactoryTrait"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.BrokerFactoryTrait</code></a></p>
  </li>
  <li>
    <p>Connectors: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/connector-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.ConnectorFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.ConnectorFactory</code></a></p>
  </li>
  <li>
    <p>Virtual Hosts: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/virtual-host-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.VirtualHostFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.VirtualHostFactory</code></a></p>
  </li>
  <li>
    <p>Route Listeners: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/router-listener-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.RouterListenerFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.RouterListenerFactory</code></a></p>
  </li>
  <li>
    <p>Stores: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/store-factory.index</code> → <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.store.StoreFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.store.StoreFactory</code></a></p>
  </li>
  <li>
    <p>Web Admin Components: <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/web-module.index</code> → <code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.web.WebModule</code></p>
  </li>
  <li>
    <p>Web Servers → <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/web-server-factory.index</code>→ <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.web.WebServerFactory"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.web.WebServerFactory</code></a></p>
  </li>
</ul>

<h3 id="extending-the-data-model">Extending the Data Model</h3>

<p>If you want to extend the Apollo xml configuration model to understand some custom JAXB object you have defined in your own packages, then you need to implement a <code class="language-plaintext highlighter-rouge">Module</code> class and then create a <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/dto-module.index</code> resource file in which you list it’s class name.</p>

<p>Example module class:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package org.example
import org.apache.activemq.apollo.util.DtoModule

class Module extends DtoModule {

  def dto_package = "org.apache.activemq.apollo.broker.store.leveldb.dto"
  def extension_classes = Array(classOf[LevelDBStoreDTO], classOf[LevelDBStoreStatusDTO])

}
</code></pre></div></div>

<p>Example <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/dto-module.index</code> resource:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.example.Module
</code></pre></div></div>

<h4 id="polymorphic-dataconfiguraiton-objects-objects">Polymorphic Data/Configuraiton objects Objects</h4>

<p>The following objects in the Apollo data model can be extended:</p>

<ul>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/VirtualHostDTO.html"><code class="language-plaintext highlighter-rouge">VirtualHostDTO</code></a></li>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/ConnectorTypeDTO.html"><code class="language-plaintext highlighter-rouge">ConnectorTypeDTO</code></a></li>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/ConnectionStatusDTO.html"><code class="language-plaintext highlighter-rouge">ConnectionStatusDTO</code></a></li>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/ProtocolDTO.html"><code class="language-plaintext highlighter-rouge">ProtocolDTO</code></a></li>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/StoreDTO.html"><code class="language-plaintext highlighter-rouge">StoreDTO</code></a></li>
  <li><a href="api/apollo-dto/org/apache/activemq/apollo/dto/StoreStatusDTO.html"><code class="language-plaintext highlighter-rouge">StoreStatusDTO</code></a></li>
</ul>

<h3 id="using-a-custom-virtualhost-implementation">Using a custom <code class="language-plaintext highlighter-rouge">VirtualHost</code> implementation</h3>

<p>Virtual hosts control the lifescycle of destinations and how producers and consumers are connected to those destinations. You can subclass the default virtual host implemenation to override the default behaviour that Apollo provides.</p>

<p>To create your own VirtualHost extension, you first extend the <a href="api/apollo-broker/index.html#org.apache.activemq.apollo.broker.VirtualHost"><code class="language-plaintext highlighter-rouge">org.apache.activemq.apollo.broker.VirtualHost</code></a> class and override it’s implemenation suite your needs. Example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package example;
class MyVirtualHost(broker: Broker, id:String) extends VirtualHost(broker, id) {
  // ... todo: override
}
</code></pre></div></div>

<p>Then, to allow an <code class="language-plaintext highlighter-rouge">apollo.xml</code> configration file you your extended version of the virtual host you need to extend the <a href="api/apollo-dto/org/apache/activemq/apollo/dto/VirtualHostDTO.html"><code class="language-plaintext highlighter-rouge">VirtualHostDTO</code></a> class to define a new XML emlement for your new virtual host type.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package example;
@XmlRootElement(name = "my_virtual_host")
@XmlAccessorType(XmlAccessType.FIELD)
class MyVirtualHostDTO extends VirtualHostDTO {
  // example config attribute
  @XmlAttribute(name="trace")
  public Boolean trace;
}
</code></pre></div></div>

<p>Since this is extending the data model, we follow the direction in the <a href="#Extending_the_Data_Model">‘Extending the Data Model’</a> section of this guide and add a <code class="language-plaintext highlighter-rouge">Module</code> class:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package example;
class Module extends DtoModule {
  def dto_package = "example"
  def extension_classes = Array(classOf[MyVirtualHostDTO])
}
</code></pre></div></div>

<p>and a <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/dto-module.index</code> resource file containing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>example.Module
</code></pre></div></div>

<p>Now that we can define an XML element to configure the custom virtual host and create it, lets define a factory class which will be used to create a <code class="language-plaintext highlighter-rouge">MyVirtualHost</code> when a <code class="language-plaintext highlighter-rouge">&lt;my_virtual_host&gt;</code> xml element is used in the configuration file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package example;
object MyVirtualHostFactory extends VirtualHostFactory {

  def create(broker: Broker, dto: VirtualHostDTO): VirtualHost = dto match {
    case dto:MyVirtualHostDTO =&gt;
      val rc = new MyVirtualHostDTO(broker, dto.id)
      rc.config = dto
      rc
    case _ =&gt; null
  }
}
</code></pre></div></div>

<p>and a <code class="language-plaintext highlighter-rouge">META-INF/services/org.apache.activemq.apollo/virtual-host-factory.index</code> resource file containing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>example.MyVirtualHostFactory
</code></pre></div></div>

<h3 id="plugging-into-the-broker-lifecycle">Plugging into the Broker Lifecycle</h3>

<p>You can implement custom <a href="api/apollo-util/index.html#org.apache.activemq.apollo.util.Service">Service</a> objects which get started / stopped when the broker starts and stops. Once you have packaged your custom service, and added it to the Apollo class path, you can update the <code class="language-plaintext highlighter-rouge">apollo.xml</code> to add the service so it gets started when apollo starts:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;service id='myservice' kind='org.example.MyService'/&gt;
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">id</code> attribute is a unique service name of your service, and the <code class="language-plaintext highlighter-rouge">kind</code> attribute is the class name of your service.</p>

<p>If your service needs a reference to the Broker object which is running in, add the following field definition to your class:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var broker:Broker = null
</code></pre></div></div>

<p>The broker instance will be injected into your class instance before it gets started.</p>

<p>Your service can also get reference to to the configuration element used to define it if it defines the following field.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var config: CustomServiceDTO
</code></pre></div></div>

<p>This field will also get injected before getting started. The <code class="language-plaintext highlighter-rouge">CustomServiceDTO.other</code> field will contain any additional configuration elements defined within service element. For example, if you configured the service as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;service id='myservice' kind='org.example.MyService'/&gt;
  &lt;options xmlns="http://example.org/myservice"&gt;
    &lt;search&gt;google.com&lt;/search&gt;
  &lt;/options&gt;
&lt;/service&gt;
</code></pre></div></div>

<p>Then you could access the options DOM element using:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    val options = config.other.get(1).asInstanceOf[Element]
</code></pre></div></div>

<p>If you had defined JAXB object mappings for the <code class="language-plaintext highlighter-rouge">&lt;options&gt;</code> class then <code class="language-plaintext highlighter-rouge">config</code> will hold that object instead of generic DOM <code class="language-plaintext highlighter-rouge">Element</code>.</p>

      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2022, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
