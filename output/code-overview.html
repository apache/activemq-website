<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Code Overview</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="developers">Developers</a> &gt; <a href="code-overview">Code Overview</a></p>

<h1 id="architecture">Architecture</h1>

<p>The following section walks through the main parts of Apache ActiveMQ and links to the code to help you understand the layout</p>

<p><img src="assets/img/BrokerDiagram.png" alt="" /></p>

<h2 id="jms-client">JMS Client</h2>

<p>The <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/package-summary.html">org.apache.activemq</a> package defines the core JMS client.</p>

<h2 id="transport">Transport</h2>

<p>The JMS client and the message broker use the <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/transport/Transport.html">Transport</a> abstraction for sending around command objects (like a distributed <em>Command Pattern</em>). A TransportChannel typically deals with some kind of networking mechanism (TCP sockets using BIO, using NIO, UDP / multicast, SSL over sockets, JXTA, EmberIO etc). See the <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/transport/package-summary.html">org.apache.activemq.transport</a> package for more details</p>

<p>So the TransportChannel is basically concerned with sending and receiving <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/Command.html">Command</a> objects (each instance represents some kind of <em>command</em>). Packet is defined in the <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/package-summary.html">org.apache.activemq.command</a> package which defines all the JMS Message implementations classes (which are Commands) along with a number of other kinds of packets, like subsciptions, message acknowledgements, transactions and so forth.</p>

<h2 id="wireformat">WireFormat</h2>

<p>There are various possible ways of encoding messages onto a stream. We may wish to adapt to various different encoding mechanisms - such as to provide simpler wire formats for talking to C / JavaScript or to make a C# friendly encoding.</p>

<p>So all the Transport  implementations take a pluggable WireFormat implementation class - which is a <em>Strategy Pattern</em> for deciding how to write the Command to a DataIn / DataOut stream or Datagram.</p>

<p>So if you wish to provide your own binary, <em>on the wire</em> protocol then we just need a WireFormat implementation of your protocol, then we can use this with any transport (TCP BIO, NIO, JXTA etc).</p>

<p>We use <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/openwire/OpenWireFormat.html">OpenWireFormat</a> by default which is the most efficient &amp; easiest format to use from Java code - so if both ends of the wire are Java then its highly recommended. Though other WireFormats are most welcome.</p>

<h2 id="default-wire-format">Default Wire Format</h2>

<p>The default wire format writes a byte which indicates the kind of Command which is being sent (see the <a href="http://activemq.apache.org/maven/5.5.0/activemq-core/apidocs/org/apache/activemq/command/CommandTypes.html">CommandTypes</a> interface which defines all the int constants for each type of command.</p>

<p>The core JMS Message types each have a unique byte ID for</p>

<ul>
  <li>Message</li>
  <li>ObjectMessage</li>
  <li>TextMessage</li>
  <li>MapMessage</li>
  <li>BytesMessage</li>
  <li>StreamMessage</li>
</ul>

<p>Then in addition there are various other <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/package-summary.html">types of command</a> such as</p>

<ul>
  <li><a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/ConnectionInfo.html">ConnectionInfo</a> for when a new connection is established with a message broker</li>
  <li><a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/ConsumerInfo.html">ConsumerInfo</a> when a new consumer is created on a connection</li>
  <li><a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/MessageAck.html">MessageAck</a> to acknowledge a message ID</li>
  <li><a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/TransactionInfo.html">TransactionInfo</a> to denote a transaction</li>
</ul>

<p>There are a few others; the <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/command/package-summary.html">org.apache.activemq.command</a> package describes them in their gory detail.</p>

<p>Basically the DefaultWireFormat has a default encoding of each of these commands. So after the first byte which indicates the type of packet is written, there is a specific wire format per packet type.</p>

<p>For new wire formats it may be that you only need to support a small subset of these types. e.g. you might just have a simple publish message, consume message &amp; message ack.</p>

<h1 id="message-broker">Message Broker</h1>

<p>The APIs for the message broker (server side of the JMS client) are defined in the <a href="http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/apache/activemq/broker/package-summary.html">org.apache.activemq.broker</a>. There are various other packages which define different parts, from the message stores to the message routing and so forth.</p>

<p>To see an overview of these packages try the <a href="docs">JavaDocs</a></p>

<hr />

<h1 id="activemq-system-overview">ActiveMQ System Overview</h1>

<h2 id="introduction">Introduction</h2>

<p>ActiveMQ is the system responsible for creating and managing network connections used for communication between clients and the broker. This document hopes to outline the inner workings of this system with in order to make it easier to understand for future developers. It will give a high-level overview of the system and outline the major players. We will also cover a few other interesting classes that may be useful to others working on the system. Most of this document is written with the server side code in mind. This is because the client-side communication systems are architecturally simple and understanding the server will make understanding clients trivial by comparison.</p>

<p>We assume the reader has basic understanding of JMS. Refer to the official Java docs for more information.</p>

<h2 id="overview-the-big-players">Overview: The Big Players</h2>

<p>The core classes involved in the ActiveMQ communication system are Transports. These include the <code class="language-plaintext highlighter-rouge">Transport</code>, <code class="language-plaintext highlighter-rouge">TransportServer</code>, and <code class="language-plaintext highlighter-rouge">TransportFactory</code> hierarchies. <code class="language-plaintext highlighter-rouge">Transport</code>s and <code class="language-plaintext highlighter-rouge">TransportServer</code>s are wrappers around sockets and server sockets respectively. <code class="language-plaintext highlighter-rouge">TransportFactory</code>s (as you may have guessed) are factories that create <code class="language-plaintext highlighter-rouge">Transport</code>s and <code class="language-plaintext highlighter-rouge">TransportServers</code>. <code class="language-plaintext highlighter-rouge">Transport</code>s are connected to <code class="language-plaintext highlighter-rouge">Broker</code>s and transmit <code class="language-plaintext highlighter-rouge">Command</code>s, which represent all major actions to be taken by ActiveMQ (more on this later). The following example illustrates how these pieces fit together.</p>

<p>The primary class needed to create a JMS “provider” application is the <code class="language-plaintext highlighter-rouge">Broker</code> class. The default ActiveMQ binary will use a <code class="language-plaintext highlighter-rouge">BrokerService</code> class to wrap around <code class="language-plaintext highlighter-rouge">Broker</code>s. When the application is started, it instantiates a <code class="language-plaintext highlighter-rouge">BrokerService</code> and instructs it to bind to a specific (local) address, say “tcp://localhost:61616”. The <code class="language-plaintext highlighter-rouge">Broker</code> will use the scheme in the given address and find the proper <code class="language-plaintext highlighter-rouge">TransportFactory</code>, <code class="language-plaintext highlighter-rouge">TcpTransportFactory</code> in this example. This factory will then be used to create a <code class="language-plaintext highlighter-rouge">TcpTransportServer</code> that will be bound to “localhost:61616”. Once the <code class="language-plaintext highlighter-rouge">TransportServer</code> is started, it will continually pole its socket for incoming connections. Successfully connected incoming sockets will be wrapped in a <code class="language-plaintext highlighter-rouge">TcpTransport</code> instance and passed back (indirectly) to the <code class="language-plaintext highlighter-rouge">Broker</code>. The <code class="language-plaintext highlighter-rouge">Broker</code> will then start polling the new <code class="language-plaintext highlighter-rouge">Transport</code> for incoming <code class="language-plaintext highlighter-rouge">Command</code>s to process.</p>

<p>The final pieces missing from the above example are the <code class="language-plaintext highlighter-rouge">TransportConnection</code> and <code class="language-plaintext highlighter-rouge">TransportConnector</code> classes. These classes are used to connect <code class="language-plaintext highlighter-rouge">Broker</code>s to <code class="language-plaintext highlighter-rouge">Transport</code>s and <code class="language-plaintext highlighter-rouge">TransportServer</code>s respectively.</p>

<h2 id="class-details">Class Details</h2>

<p>This section will explain some of the more interesting details of the mentioned classes separately.</p>

<h3 id="transports-transportservers-and-transportfactories">Transports, TransportServers, and TransportFactories</h3>

<p>The basic principles of how these classes operate are very simple: <code class="language-plaintext highlighter-rouge">Transport</code>s and <code class="language-plaintext highlighter-rouge">TransportServer</code>s are wrappers around sockets and server sockets used to hide implementation, and <code class="language-plaintext highlighter-rouge">TransportFactory</code>s are factory classes for the mentioned classes. The only caveats are how <code class="language-plaintext highlighter-rouge">TransportFactory</code>s are chosen and configured based on URIs they are supplied.</p>

<p>The <code class="language-plaintext highlighter-rouge">TransportFactory</code> class is abstract and incapable of creating <code class="language-plaintext highlighter-rouge">Transport</code> or <code class="language-plaintext highlighter-rouge">TransportServer</code> classes directly. It, nevertheless, is the class used to create <code class="language-plaintext highlighter-rouge">Transport</code>s and <code class="language-plaintext highlighter-rouge">TransportServer</code>s. <code class="language-plaintext highlighter-rouge">TransportFactory</code> delegates its responsibilities to its subclasses based on the choice of subclass provided by the <code class="language-plaintext highlighter-rouge">FactoryFinder</code> class, which uses the URI’s scheme to find a matching factory classes based on text files stored under the META-INF directory.</p>

<p>Configuration of the created <code class="language-plaintext highlighter-rouge">Transport</code>s is done entirely to reflection. <code class="language-plaintext highlighter-rouge">Transport</code>s are configured through calls to <code class="language-plaintext highlighter-rouge">compositeConfigure</code>, which are made by the factory at the time of the <code class="language-plaintext highlighter-rouge">Transport</code>’s creation. <code class="language-plaintext highlighter-rouge">compositeConfigure</code> uses the <code class="language-plaintext highlighter-rouge">IntrospectionSupport</code> class to call setters for parameters passed in through the URI. For example, creating a <code class="language-plaintext highlighter-rouge">Transport</code> using the URI “ssl://localhost:61616/?needClientAuth=true” would result in the creation of an <code class="language-plaintext highlighter-rouge">SslTransport</code> object whose <code class="language-plaintext highlighter-rouge">setNeedClientAuth</code> method (if it exists) is called with the value of <code class="language-plaintext highlighter-rouge">true</code> immediately after its creation. <code class="language-plaintext highlighter-rouge">TransportServer</code>s operate in a similar fashion. The only difference is that the call to <code class="language-plaintext highlighter-rouge">IntrospectionSupport</code> is made from the <code class="language-plaintext highlighter-rouge">doBind</code> method of the <code class="language-plaintext highlighter-rouge">TransportFactory</code>.</p>

<h3 id="commands">Commands</h3>

<p><code class="language-plaintext highlighter-rouge">Command</code>s are the main means for communication within <code class="language-plaintext highlighter-rouge">Broker</code>s. Each <code class="language-plaintext highlighter-rouge">Command</code> represents an action to be taken. <code class="language-plaintext highlighter-rouge">Command</code> subclasses include <code class="language-plaintext highlighter-rouge">ConnectionInfo</code>, <code class="language-plaintext highlighter-rouge">KeepAliveInfo</code>, and <code class="language-plaintext highlighter-rouge">Message</code>, which result in processing of new connections, maintenance of old connections, and processing of user messages respectively. These classes are de-serialized from <code class="language-plaintext highlighter-rouge">Transport</code>s using Marshalers. Whenever new data is found in a socket, the first byte is read to determine what type of <code class="language-plaintext highlighter-rouge">Command</code> being received. The proper Marshaller is then selected to de-serialize the <code class="language-plaintext highlighter-rouge">Command</code> (e.g. to de-serialize a <code class="language-plaintext highlighter-rouge">ConnectionInfo</code>, the <code class="language-plaintext highlighter-rouge">ConnectionInfoMarshaller</code> is used).</p>

<h3 id="transportconnections-and-transportconnectors">TransportConnections and TransportConnectors</h3>

<p>Every <code class="language-plaintext highlighter-rouge">TransportServer</code> is connected to a <code class="language-plaintext highlighter-rouge">Broker</code> using a <code class="language-plaintext highlighter-rouge">TransportConnector</code>. The server’s accept listener (which is called when a new <code class="language-plaintext highlighter-rouge">Transport</code> is constructed) is set to call the given <code class="language-plaintext highlighter-rouge">TransportConnector</code>’s <code class="language-plaintext highlighter-rouge">createConnection</code> method with the new <code class="language-plaintext highlighter-rouge">Transport</code>. When called, <code class="language-plaintext highlighter-rouge">createConnection</code> creates a new <code class="language-plaintext highlighter-rouge">TransportConnection</code> that links the given <code class="language-plaintext highlighter-rouge">Transport</code> and the supporting <code class="language-plaintext highlighter-rouge">Broker</code> together; the <code class="language-plaintext highlighter-rouge">Transport</code>’s transport listener is set to the <code class="language-plaintext highlighter-rouge">TransportConnection</code>’s <code class="language-plaintext highlighter-rouge">onCommand</code> method, which is then called whenever a new <code class="language-plaintext highlighter-rouge">Command</code> is received.</p>

<p><code class="language-plaintext highlighter-rouge">Command</code>s and <code class="language-plaintext highlighter-rouge">AbstractConnection</code> (the superclass of <code class="language-plaintext highlighter-rouge">TransportConnection</code>) form a visitor pattern. <code class="language-plaintext highlighter-rouge">onCommand</code> will call <code class="language-plaintext highlighter-rouge">AbstractConnection</code>’s service method which will make a series of calls in line with the visitor patter and eventually, the proper <code class="language-plaintext highlighter-rouge">Command</code> subclass to be passed to the corresponding method of the <code class="language-plaintext highlighter-rouge">Broker</code> for processing.</p>

<h3 id="brokerfilters-and-brokerplugins">BrokerFilters and BrokerPlugins</h3>

<p>While not used directly by the communication system, <code class="language-plaintext highlighter-rouge">BrokerFilter</code>s and <code class="language-plaintext highlighter-rouge">BrokerPlugin</code>s provide an effective and easy to use way of modifying Broker behavior. <code class="language-plaintext highlighter-rouge">BrokerFilter</code>s allow for one to modify a few <code class="language-plaintext highlighter-rouge">Broker</code> methods without touching the rest (as the name suggests). The <code class="language-plaintext highlighter-rouge">BrokerFilter</code> passes on all of its responsibilities to a <code class="language-plaintext highlighter-rouge">Broker</code> it receives in its constructor. Subclassing <code class="language-plaintext highlighter-rouge">BrokerFilter</code> allows us to perform additional actions before passing the work down to the underlying <code class="language-plaintext highlighter-rouge">Broker</code>.</p>

<p>The power of the <code class="language-plaintext highlighter-rouge">BrokerFilter</code> class comes from the fact that multiple filters can be cascaded to create different functional combinations. As an example, the <code class="language-plaintext highlighter-rouge">JaasAuthenticationBroker</code> is a subclass of <code class="language-plaintext highlighter-rouge">BrokerFilter</code> that modifies the methods used for adding and removing connections to allow for JAAS authentication. <code class="language-plaintext highlighter-rouge">AuthorizationBroker</code> is another subclass of <code class="language-plaintext highlighter-rouge">BrokerFilter</code>. This class modifies the destination regulation methods to enforce access levels. With this architecture, one can create a <code class="language-plaintext highlighter-rouge">JaasAuthenticationBroker</code> and have it use an <code class="language-plaintext highlighter-rouge">AuthorizationBroker</code> as its underlying broker (which would use another broker itself, etc.).</p>

<p><code class="language-plaintext highlighter-rouge">BrokerPlugin</code>s are simple classes that will wrap their corresponding <code class="language-plaintext highlighter-rouge">Brokers</code> around the one they are given. i.e. “installing” an <code class="language-plaintext highlighter-rouge">AuthorizationPlugin</code> on an existing <code class="language-plaintext highlighter-rouge">Broker</code> will create an <code class="language-plaintext highlighter-rouge">AuthorizationBroker</code> that uses the original <code class="language-plaintext highlighter-rouge">Broker</code> internally. The main reason for the existence of <code class="language-plaintext highlighter-rouge">BrokerPlugin</code>s is to allow for one to configure the <code class="language-plaintext highlighter-rouge">Broker</code> used by the <code class="language-plaintext highlighter-rouge">BrokerService</code> class (either through code or XML configuration and spring).</p>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2021, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
