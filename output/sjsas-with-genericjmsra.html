<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/news">News</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ "Classic"</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Community<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact">Contact Us</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contributing">Contribute</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/support">Get Support</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><img src="/assets/img/feather.png" style="height:20px">Apache<span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>SJSAS with GenericJMSRA</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="connectivity">Connectivity</a> &gt; <a href="containers">Containers</a> &gt; <a href="sjsas-with-genericjmsra">SJSAS with GenericJMSRA</a></p>

<h1 id="using-activemq-generic-jms-ra-and-sjsas-glassfish">Using ActiveMQ, Generic JMS RA and SJSAS (Glassfish)</h1>

<p>This document is my notes on making ActiveMQ and SJSAS work together using GenericJMSRA. The objectives is to make ActiveMQ as the JMS provider and MDB can be deployed in SJSAS, listening messages from ActiveMQ. Please note that, the SJSAS version I use is 9.0 Update 1. I don’t have time to test it with SJSAS 9.1 or Glassfish v2.</p>

<h2 id="the-procedures">The procedures</h2>

<p>First, download all binaries:</p>

<ul>
  <li>genericra 1.7 (rar)</li>
  <li>activemq 4.1.1 (zip or tar.gz)</li>
</ul>

<p>The activemq have some dependencies, however, you can easily found all of them in the distribution (the zip or tar.gz). The following is list of minimum dependencies:</p>

<ul>
  <li>activemq-core</li>
  <li>activeio</li>
  <li>commons-logging</li>
  <li>backport-util-concurrent</li>
</ul>

<p>In order to use genericra you need to first create a resource adapter config using asadmin (Command line tools of SJSAS).</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin create-resource-adapter-config
  --property
      SupportsXA=false
      :RMPolicy=OnePerPhysicalConnection
      :ProviderIntegrationMode=javabean
      :ConnectionFactoryClassName=org.apache.activemq.ActiveMQConnectionFactory
      :QueueConnectionFactoryClassName=org.apache.activemq.ActiveMQConnectionFactory
      :TopicConnectionFactoryClassName=org.apache.activemq.ActiveMQConnectionFactory
      :XAConnectionFactoryClassName=org.apache.activemq.ActiveMQXAConnectionFactory
      :XAQueueConnectionFactoryClassName=org.apache.activemq.ActiveMQXAConnectionFactory
      :XATopicConnectionFactoryClassName=org.apache.activemq.ActiveMQXAConnectionFactory
      :UnifiedDestinationClassName=org.apache.activemq.command.ActiveMQDestination
      :QueueClassName=org.apache.activemq.command.ActiveMQQueue
      :TopicClassName=org.apache.activemq.command.ActiveMQTopic
      :ConnectionFactoryProperties=brokerURL\\\=tcp\\\://127.0.0.1\\\:61616
      :LogLevel=FINE
  myapp#genericra
</code></pre></div></div>
<p>You should note that, the above command should executed as one single line and no space around ‘:’. Just like:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin create-resource-adapter-config --property SupportsXA=false:ConnectionFactoryProperties=brokerURL=tcp://127.0.0.1:61616 myapp#genericra
</code></pre></div></div>
<p>Under DOS prompt, you should use ONLY ONE ‘/’ to do espcape, like this.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin create-resource-adapter-config --property SupportsXA=false:ConnectionFactoryProperties=brokerURL=tcp://127.0.0.1:61616 myapp#genericra
</code></pre></div></div>
<p>Package your application, genericra.rar and activemq dependencies in one single EAR. The structure of the EAR should like this:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lib/activemq-core-4.1.1.jar
lib/log4j-1.2.13.jar
lib/commons-logging-1.1.jar
lib/backport-util-concurrent-2.1.jar
lib/activeio-core-3.0.0-incubator.jar
META-INF/application.xml
genericra.rar
mymodules.jar
</code></pre></div></div>
<p>Inside the mymodules.jar (where I put my MDB), the sun-ejb-jar.xml should look like this:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE sun-ejb-jar
  PUBLIC "-//Sun Microsystems, Inc.//DTD Application Server 8.1 EJB 2.1//EN"
    "http://www.sun.com/software/appserver/dtds/sun-ejb-jar\_2\_1-1.dtd"&gt;</span>
<span class="nt">&lt;sun-ejb-jar&gt;</span>
  <span class="nt">&lt;enterprise-beans&gt;</span>
    <span class="nt">&lt;ejb&gt;</span>
      <span class="nt">&lt;ejb-name&gt;</span>TestingMessageDrivenBean<span class="nt">&lt;/ejb-name&gt;</span>
      <span class="nt">&lt;mdb-connection-factory&gt;</span>
        <span class="nt">&lt;jndi-name&gt;</span>jms/SimpleQueueConnectionFactory<span class="nt">&lt;/jndi-name&gt;</span>
      <span class="nt">&lt;/mdb-connection-factory&gt;</span>
      <span class="nt">&lt;mdb-resource-adapter&gt;</span>
        <span class="nt">&lt;resource-adapter-mid&gt;</span>myapp#genericra<span class="nt">&lt;/resource-adapter-mid&gt;</span>
        <span class="nt">&lt;activation-config&gt;</span>
          <span class="nt">&lt;activation-config-property&gt;</span>
            <span class="nt">&lt;activation-config-property-name&gt;</span>DestinationType<span class="nt">&lt;/activation-config-property-name&gt;</span>
            <span class="nt">&lt;activation-config-property-value&gt;</span>javax.jms.Queue<span class="nt">&lt;/activation-config-property-value&gt;</span>
          <span class="nt">&lt;/activation-config-property&gt;</span>
          <span class="nt">&lt;activation-config-property&gt;</span>
            <span class="nt">&lt;activation-config-property-name&gt;</span>DestinationProperties<span class="nt">&lt;/activation-config-property-name&gt;</span>
            <span class="nt">&lt;activation-config-property-value&gt;</span>PhysicalName=Foo.Bar<span class="nt">&lt;/activation-config-property-value&gt;</span>
          <span class="nt">&lt;/activation-config-property&gt;</span>
        <span class="nt">&lt;/activation-config&gt;</span>
      <span class="nt">&lt;/mdb-resource-adapter&gt;</span>
    <span class="nt">&lt;/ejb&gt;</span>
  <span class="nt">&lt;/enterprise-beans&gt;</span>
<span class="nt">&lt;/sun-ejb-jar&gt;</span>
</code></pre></div></div>
<p>And the application.xml should look like this:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;application</span>
    <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/application_5.xsd"</span>
    <span class="na">version=</span><span class="s">"5"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;description&gt;</span>Example DD<span class="nt">&lt;/description&gt;</span>
  <span class="nt">&lt;display-name&gt;</span>sample app with amq and genericra<span class="nt">&lt;/display-name&gt;</span>
  <span class="nt">&lt;module&gt;</span>
    <span class="nt">&lt;ejb&gt;</span>mymodules.jar<span class="nt">&lt;/ejb&gt;</span>
  <span class="nt">&lt;/module&gt;</span>
  <span class="nt">&lt;module&gt;</span>
    <span class="nt">&lt;connector&gt;</span>genericra.rar<span class="nt">&lt;/connector&gt;</span>
  <span class="nt">&lt;/module&gt;</span>
<span class="nt">&lt;/application&gt;</span>
</code></pre></div></div>
<p>Deploy the genericra:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin deploy --name myapp myapp.ear
</code></pre></div></div>
<p>Create connection pool. Run the following command in one single line:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin create-connector-connection-pool
  --raname myapp#genericra
  --connectiondefinition javax.jms.QueueConnectionFactory
  --transactionsupport LocalTransaction
  ActiveMQQueueConnectionFactoryPool
</code></pre></div></div>
<p>Create connection factory admin object. Run the following command in one single line, note that, “jms/SimpleQueueConnectionFactory” need to match in your sun-ejb-jar.xml:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asadmin create-connector-resource
  --poolname ActiveMQQueueConnectionFactoryPool
  jms/SimpleQueueConnectionFactory
</code></pre></div></div>

<h2 id="classloader--commons-logginglog4j-issue">Classloader / commons-logging+log4j issue</h2>

<p>In the procedure shown above, you should notice one thing, ie, the RA, ActiveMQ and my MDB is deployed as one single EAR. You can deploy the genericra standalone without putting it into the ear, provided that you are not using commons-logging and log4j (directly or indirectly).</p>

<p>In the application I’m working on, commons-logging is used, and ActiveMQ also use commons-logging. In SJSAS, connector classloader is parent of the application classloader, as a result, if you deploy genericra independently, and then you deploy your application, log4j.xml will never get loaded except you put your application log4j.xml along with the ActiveMQ jars.</p>

<p>With Java standard classloading procedure, classloader will first delegate the loading to parent. When application classloader lookup the LogFactory class, it will first delegate to its parent classloader (ie the connector classloader). As the connector classloader have loaded ActiveMQ and its dependencies (which include commons-logging), LogFactory will finally loaded by the connector classloader. When commons-logging try to initialize the LogFactoryImpl, and hence trigger the standard procedure of log4j initialization, log4j configuration (log4j.xml or log4j.properties) in your application will not get loaded (as log4j logger is loaded by connector classloader).</p>

<p>As a result, deploy genericra independently is not the perfect solution in this case.</p>

<p>Luckily, with some advice from Glassfish forum (thanks Sivakumar), I worked out a better solution, ie, packaged all things (including genericra and activemq) into one EAR. When packaged in this way, all classes will be loaded under one classloader, and the good thing is, you can put your log4j.xml within one of the your jar (ie, the normal way!).</p>

<p>However, you should note one minor point, deploying genericra standalone and packaged with the EAR have one minor difference. If you deploy the RA with EAR, you need to reference the RA using the format ‘appName#raName’. As a result, the reference name of the RA is myapp#genericra (see create-resource-adapter-config and sun-ejb-jar.xml part).</p>

<p>If you deploy the RA independently, the ra name is just genericra (as shown in the example by Ramesh).</p>

<h2 id="localtransaction">LocalTransaction</h2>

<p>In the instruction described above, LocalTransaction is used. (SupportsXA=false and –transactionsupport LocalTransaction) as I am currently using Non-XA transaction, however, as example shown by Ramesh, XA should also work.</p>

<h2 id="configuring-genericra">Configuring genericra</h2>

<p>When you create the resource-adapter-config, there is two way to configure. One way is using JNDI, another way is using JavaBean introspection feature of genericra. In the example above, I go with JavaBean introspection feature (so ‘ProviderIntegrationMode=javabean’). For more details on this, please checkout the user guide of genericra. Also, I found that expample provided on the genericra website is also valuable resource.</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="http://weblogs.java.net/blog/rampsarathy/archive/2007/03/glassfish_v2_an_1.html">Another example on using genericjmsra and activemq by Ramesh</a></li>
  <li><a href="https://genericjmsra.dev.java.net/docs/userguide/userguide.html">Official user guide on configuring genericjmsra</a></li>
  <li><a href="http://forums.java.net/jive/thread.jspa?messageID=211849">The thread in Glassfish forum which I found my answer</a></li>
</ul>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p><a href="https://www.apache.org/foundation/marks/list/">Apache, ActiveMQ, Apache ActiveMQ</a>, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2021, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
