<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/index.html">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components</a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ 5</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contact</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#mailing">Mailing Lists</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#chat">Chat</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#contributing">Contributing</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories.html">Security</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Apache</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories.html">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Why do KahaDB log files remain after cleanup</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p> <a href="faq">FAQ</a> &gt; <a href="errors">Errors</a> &gt; <a href="why-do-kahadb-log-files-remain-after-cleanup">Why do KahaDB log files remain after cleanup</a></p>

<p>Clean-up of un-referenced KahaDB journal log files <strong><code class="language-plaintext highlighter-rouge">data-&lt;id&gt;.log</code></strong> will occur every 30 seconds by default. If a data file is in-use it will not be cleaned up.</p>

<p>A data file may be in-use because:</p>

<ol>
  <li>It contains a pending message for a destination or durable topic subscription</li>
  <li>It contains an ACK for a message which is in an in-use data file - the ACK cannot be removed as a recovery would then mark the message for redelivery</li>
  <li>The journal references a pending transaction</li>
  <li>It is a journal file, and there may be a pending write to it</li>
</ol>

<p>The <strong><code class="language-plaintext highlighter-rouge">TRACE</code></strong> level logging of the <strong><code class="language-plaintext highlighter-rouge">org.apache.activemq.store.kahadb.MessageDatabase</code></strong> class provides insight into the cleanup process and will allow you to determine why a given data file is considered in-use and as a result, not a candidate for cleanup.</p>

<p>To debug, add the following (or similar) to your <strong><code class="language-plaintext highlighter-rouge">log4j.properties</code></strong> file (if needed):</p>

<p>log4j.appender.kahadb=org.apache.log4j.RollingFileAppender 
log4j.appender.kahadb.file=${activemq.base}/data/kahadb.log 
log4j.appender.kahadb.maxFileSize=1024KB 
log4j.appender.kahadb.maxBackupIndex=5 
log4j.appender.kahadb.append=true 
log4j.appender.kahadb.layout=org.apache.log4j.PatternLayout 
log4j.appender.kahadb.layout.ConversionPattern=%d [%-15.15t] %-5p %-30.30c{1} - %m%n 
log4j.logger.org.apache.activemq.store.kahadb.MessageDatabase=TRACE, kahadb</p>

<p>Either restart ActiveMQ and let the cleanup process run (give it a minute or two for example) or alternatively apply this logging configuration to a running broker via JMX. The <strong><code class="language-plaintext highlighter-rouge">Broker</code></strong> MBean exposes an operation called <strong><code class="language-plaintext highlighter-rouge">reloadLog4jProperties</code></strong> in JMX that can be used to tell the broker to reload its <strong><code class="language-plaintext highlighter-rouge">log4j.properties</code></strong>. Often its enough to apply this logging configuration for 2-5 minutes and then analyze the broker’s log file.</p>

<p>Examine the log file and look for cleanup of the data files. The process starts with the complete set of known data files and queries the index on a per destination basis to prune this list. Anything that remains is a candidate for cleanup. The trace logging gives the destination and the log file numbers that remain candidates for removal as it iterates through the index.</p>

<p>At some point you’ll hit a destination and the number of data file ids will suddenly drop because that destination references them. It could be a DLQ or an offline durable subscriber. In any event, the logging will help you pinpoint the destinations that are hogging disk space.</p>

<p>Here is a quick sample:</p>

<table>
  <tbody>
    <tr>
      <td>TRACE</td>
      <td>Last update: 164:41712, full gc candidates set: [86, 87, 163, 164]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after first tx:164:41712, [86, 87, 163]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:A, [86, 87, 163]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:1:B, [86, 87, 163]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:D, [86, 87, 163]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:E, [86, 87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:H, [86, 87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:I, [86, 87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates after dest:0:J, [87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>TRACE</td>
      <td>gc candidates: [87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
    <tr>
      <td>DEBUG</td>
      <td>Cleanup removing the data files: [87]</td>
      <td>org.apache.activemq.store.kahadb.MessageDatabase</td>
      <td>ActiveMQ Journal Checkpoint Worker</td>
    </tr>
  </tbody>
</table>

<p>We get one candidate, <strong><code class="language-plaintext highlighter-rouge">data-87.log</code></strong> from the existing set of journal data files <strong><code class="language-plaintext highlighter-rouge">[86, 87, 163, 164]</code></strong>. There is a current transaction using <strong><code class="language-plaintext highlighter-rouge">164</code></strong>, destination (Queue named <strong><code class="language-plaintext highlighter-rouge">E</code></strong>) <code class="language-plaintext highlighter-rouge">'**0:E**'</code> has some messages in <strong><code class="language-plaintext highlighter-rouge">163</code></strong>, destination <code class="language-plaintext highlighter-rouge">'**0:I**'</code> has messages in <strong><code class="language-plaintext highlighter-rouge">86</code></strong> and <strong><code class="language-plaintext highlighter-rouge">87</code></strong> is un-referenced. In this case, there must be some long standing un-acknowledged messages or a very slow consumer on destination <code class="language-plaintext highlighter-rouge">'**0:I**'</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">'**0:**'</code> prefix is shorthand for a queue, <code class="language-plaintext highlighter-rouge">'**1:**'</code> for a topic. Example: <strong><code class="language-plaintext highlighter-rouge">dest:1:B</code></strong> refers to a topic named <strong><code class="language-plaintext highlighter-rouge">B</code></strong>.</p>

<hr />

<h3 id="non-persistent-messages">Non-persistent messages</h3>

<p>Similar for non-persistent messages that are not stored in your configured KahaDB persistence adapter but get swapped to temp storage once they exceed the broker’s configured <strong><code class="language-plaintext highlighter-rouge">memoryUsage</code></strong> limit. A similar logging configuration can show details of the cleanup of temp storage.</p>

<p>log4j.appender.kahadb=org.apache.log4j.RollingFileAppender
log4j.appender.kahadb.file=${activemq.base}/data/kahadb.log
log4j.appender.kahadb.maxFileSize=1024KB
log4j.appender.kahadb.maxBackupIndex=5
log4j.appender.kahadb.append=true
log4j.appender.kahadb.layout=org.apache.log4j.PatternLayout
log4j.appender.kahadb.layout.ConversionPattern=%d [%-15.15t] %-5p %-30.30c{1} - %m%n
log4j.logger.org.apache.activemq.store.kahadb=TRACE, kahadb
log4j.logger.org.apache.activemq.store.kahadb.MessageDatabase=INFO, kahadb
 </p>

<p>Note the last line of above logging configuration disables the verbose logging of the KahaDB cleanup task. If that line gets removed, the cleanup details of both KahaDB and temp storage will be logged to the same file but you need to be careful not to mix the logging output.</p>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p>Apache ActiveMQ, ActiveMQ, ActiveMQ Artemis, Apache, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2019, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
