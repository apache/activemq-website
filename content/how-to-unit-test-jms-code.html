<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/assets/img/favicon.png">

    <link rel="stylesheet" href="/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="/"><img src="/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/index.html">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownComponents" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Components</a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownComponents">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/components/classic">ActiveMQ 5</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/components/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contact</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#mailing">Mailing Lists</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#chat">Chat</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/contact#contributing">Contributing</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories.html">Security</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Apache</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/security-advisories.html">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>How To Unit Test JMS Code</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p> <a href="faq">FAQ</a> &gt; <a href="jms">JMS</a> &gt; <a href="how-to-unit-test-jms-code">How To Unit Test JMS Code</a></p>

<p>When unit testing code with JMS you’ll typically want to avoid the overhead of running separate proceses; plus you’ll want to increase startup time as fast as possible as you tend to run unit tests often and want immediate feedback. Also persistence can often cause problems - as previous test case results can adversely affect future test case runs - so you often need to purge queues on startup.</p>

<p>So when unit testing JMS code we recommend the following</p>

<ul>
  <li>Use <a href="how-do-i-embed-a-broker-inside-a-connection">an embedded broker</a> to avoid a separate broker process being required.</li>
  <li>Disable <a href="broker-configuration-uri">broker persistence</a> so that no queue purging is required before/after tests.</li>
  <li>It’s often simpler and faster to just use Java code to create the broker via an XML configuration file using Spring etc.</li>
</ul>

<p>You can do all of this using the following Java code to create your JMS <code class="highlighter-rouge">ConnectionFactory</code> which will also automatically create an embedded broker</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ConnectionFactory connectionFactory = new ActiveMQConnectionFactory("vm://localhost?broker.persistent=false");
</code></pre></div></div>
<p>For more configuration options see the <a href="vm-transport-reference">VM Transport Reference</a> and the <a href="broker-configuration-uri">Broker Configuration URI</a></p>

<p>Or if you really would rather be more explicit you can create the broker first using the following Java code</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BrokerService broker = new BrokerService();
broker.setPersistent(false);
broker.start();
</code></pre></div></div>
<p>or you could use <a href="spring-Community/support">Spring Support.</a></p>

<h3 id="using-jndi">Using JNDI</h3>

<p>If your application code is using JNDI to lookup the JMS <code class="highlighter-rouge">ConnectionFactory</code> and <code class="highlighter-rouge">Destination</code>’s to use, then you could use the <a href="jndi-support">JNDI Support</a> in ActiveMQ.</p>

<p>Add the following <code class="highlighter-rouge">jndi.properties</code> to your classpath, e.g., in <code class="highlighter-rouge">src/test/resources</code>, if you are using maven:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java.naming.factory.initial = org.apache.activemq.jndi.ActiveMQInitialContextFactory
java.naming.provider.url = vm://localhost?broker.persistent=false
</code></pre></div></div>
<p>You should then consider using <a href="jndi-Community/support">Dynamic destinations in JNDI</a> so that your code looks up destinations via</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context.lookup("dynamicQueues/FOO.BAR");
</code></pre></div></div>

<h3 id="using-theembeddedactivemqbroker-junit-rule-activemq-513">Using The <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> JUnit Rule (ActiveMQ 5.13)</h3>

<p>If your test code is using JUnit, then you could use the <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> JUnit Rule provided in the <code class="highlighter-rouge">activemq-junit</code> library. Add the <code class="highlighter-rouge">activemq-junit</code> library along with the <code class="highlighter-rouge">activemq-broker</code> libraries for the version of ActiveMQ you want to test with.  The rule will use whatever version of ActiveMQ it finds in the classpath, so the ActiveMQ libraries need to be specified if they are not already there.</p>

<p>If you are using Maven, add the following to your <code class="highlighter-rouge">pom.xml</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq.tooling&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-junit&lt;/artifactId&gt;
    &lt;version&gt;${activemq-junit-version}&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt; 

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-broker&lt;/artifactId&gt;
    &lt;version&gt;${activemq-version}&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre></div></div>
<p> Then add the <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> JUnit Rule to your test, and JUnit will start the embedded broker at the beginning of each test and stop the broker at the end of the test.</p>

<p><strong>Use The ActiveMQ JUnit Rule</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Rule
public EmbeddedActiveMQBroker broker = new EmbeddedActiveMQBroker();
</code></pre></div></div>
<p>By default, the <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> will configure the broker as non-persistent, and the only transport available will be the VM transport. To customize this configuration, either extend the <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> class and override the <code class="highlighter-rouge">configure()</code> method, or use an XML configuration for the broker.  </p>

<p><strong>Note</strong>: to configure an <code class="highlighter-rouge">EmbeddedActiveMQBroker</code> using XML configuration, you may need to add additional libraries to the classpath to support XBean configuration of ActiveMQ.</p>

<p><strong>Customizing An EmbeddedActiveMQBroker Using Java</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Rule
EmbeddedActiveMQBroker customizedBroker = new EmbeddedActiveMQBroker() {
    @Override
    protected void configure() {
        // Perform additional configuration here...
    }
}
</code></pre></div></div>

<p><strong>Customizing An EmbeddedActiveMQBroker Using XML Configuration</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Rule
EmbeddedActiveMQBroker customizedBroker = new EmbeddedActiveMQBroker("bean:customize-activemq.xml");
</code></pre></div></div>
<p>Note that to use the XML configuration, you may need to add additional libraries on the classpath to support the XBean configuration of ActiveMQ.  The versions of the <code class="highlighter-rouge">spring-context</code> library should correspond with the version used by your selected version of ActiveMQ.</p>

<p><strong>Maven Configuration For XBean Configuration</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
    &lt;version&gt;Appropriate version for activemq-version&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-spring&lt;/artifactId&gt;
    &lt;version&gt;${activemq-version&gt;&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div></div>
<p>Then you can use the VM URI to connect with the broker</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ConnectionFactory connectionFactory = new ActiveMQConnectionFactory("vm://embedded-broker?create=false");
</code></pre></div></div>
<p>You can also get a connection factory from the <code class="highlighter-rouge">EmbeddedActiveMQBroker</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ConnectionFactory connectionFactory = embeddedBroker.createConnectionFactory();
</code></pre></div></div>

      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p>Apache ActiveMQ, ActiveMQ, ActiveMQ Artemis, Apache, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2019, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
